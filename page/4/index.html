<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>kame</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="个人文章博客站点">
<meta property="og:type" content="website">
<meta property="og:title" content="kame">
<meta property="og:url" content="http://www.wokoweb.com/page/4/index.html">
<meta property="og:site_name" content="kame">
<meta property="og:description" content="个人文章博客站点">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="kame">
<meta name="twitter:description" content="个人文章博客站点">
  
    <link rel="alternate" href="/atom.xml" title="kame" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">kame</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://www.wokoweb.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-mongdb数据导出" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/08/14/mongdb数据导出/" class="article-date">
  <time datetime="2016-08-14T00:00:00.000Z" itemprop="datePublished">2016-08-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/08/14/mongdb数据导出/">mongodb 数据导出</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>mongdb  数据导出脚本</p>
</blockquote>
<pre><code>#!/bin/bash
mysql_user_pwd=&quot;--login-path=zabbix&quot;
mysql_db=XXXXX
input_file_dir=/tmp/count
select_into=&quot;/root/scripts/select_mysql.sql&quot;
if [ ! -d &quot;$input_file_dir&quot; ];then
    mkdir $input_file_dir;
fi
### output mysqldb to text!
select_all_tmp_mongo=&quot;select mytitle AS \&quot;类别指标\&quot;, (case  git  when &apos;3&apos; then &apos;铁血屠龙&apos; when  &apos;2&apos; then &apos;像素骑士团&apos;  when &apos;1&apos; then &apos;封神伏魔&apos; END ) AS \&quot;游戏名称\&quot;, cnt AS \&quot;数量\&quot; ,data_time AS \&quot;记录时间\&quot;  INTO OUTFILE &apos;$input_file_dir/$(date +%Y%m%d).text&apos; FIELDS TERMINATED BY &apos;,&apos; OPTIONALLY ENCLOSED BY &apos;\&quot;&apos; LINES TERMINATED BY &apos;\n&apos; FROM tmp_mongo where data_time like &apos;%$(date +%Y-%m-%d)%&apos;;&quot;

####input mysql db start
mysql  $mysql_user_pwd $mysql_db &lt;$select_into
####input mongo db
ssh localhost /root/scripts/day_select_mongo.sh &gt;$input_file_dir/tmp_mongo.txt
while read line
do
        a=`echo $line | awk &apos;{print $1}&apos;`
        b=`echo $line | awk &apos;{print $2}&apos;`
        c=`echo $line | awk &apos;{print $3}&apos;`
        mysql $mysql_user_pwd  $mysql_db -e &quot;insert into tmp_mongo  values (&apos;$a&apos;,&apos;$b&apos;,&apos;$c&apos;,now());&quot;
done &lt;$input_file_dir/tmp_mongo.txt
#### Mysql db output to csv
#
#echo &quot; into CSV  at time  $(date +%Y%m%d%H%M%S)&quot;
#
# mysql $mysql_user_pwd $mysql_db --default-character-set=utf8 -e &quot;$select_all_tmp_mongo&quot;  | awk &apos;{print $1,$2,$3,$4}&apos; &gt;$input_file_dir/tmp_all.html
#
# mysql $mysql_user_pwd $mysql_db  --default-character-set=utf8 -e &quot;$select_all_tmp_mongo&quot; | sed &apos;s/\t/&quot;,&quot;/g;s/^/&quot;/;s/$/&quot;/;s/\n//g&apos; &gt;$input_file_dir/tmp_all.csv
#if [ $? -eq 0 ];then
#        echo &quot;Mysql output to CSV  finshed_time is  $(date +%Y%m%d%H%M%S)&quot;
#
#    iconv -f utf-8 -t gb2312 $input_file_dir/tmp_all.csv &gt;$input_file_dir/Count_$(date +%Y%m%d%H%M%S).csv
#
#    if [ $? -eq 0 ];then
#            echo &quot;Csv iconv to gb2312  finshed_time is  $(date +%Y%m%d%H%M%S)&quot;
#        exit 0
#    else
#            echo &quot;Csv iconv to gb2312 is fail! at $(date +%Y%m%d%H%M)&quot;
#        exit 1
#    fi
#    exit 0
#else
#    echo &quot;Mysql output to CSV is fail! at $(date +%Y%m%d%H%M)&quot;
#    exit 1
#fi
chown  -R mysql.mysql  $input_file_dir
mysql $mysql_user_pwd $mysql_db -e &quot;$select_all_tmp_mongo&quot;
if [ $? -eq 0 ];then
    echo &quot;Mysqldb output to $input_file_dir/$(date +%Y%m%d%).text is successful finshed_time is  $(date +%Y%m%d%H%M%S)&quot;
    cat $input_file_dir/$(date +%Y%m%d).text  | sed -e &apos;1 i\&quot;指标名称&quot;,&quot;游戏类别&quot;,&quot;数据值&quot;,&quot;记录时间\&quot;&apos; | sed -e &apos;s/^&quot;/\&lt;tr bgcolor=&quot;#cccccc&quot;&gt;\&lt;td&gt;/&apos; | sed -e &apos;s/&quot;,&quot;/\&lt;\/td&gt;&lt;td&gt;/g&apos; | sed -e &apos;s/&quot;$/\&lt;\/td&gt;\&lt;\/tr&gt;/&apos; | sed -e &apos;1 i\&lt;table border=2 width=750 align=center&gt;&apos; | sed -e &apos;$ a\&lt;\/table&gt;&apos; | sed -e &apos;1 a\&lt;h2 align=center&gt;AP-GAME-各项指标\&lt;/h2&gt;&apos; &gt;$input_file_dir/$(date +%Y%m%d).html

    if [ $? -eq 0 ];then
        echo &quot;$input_file_dir/$(date +%Y%m%d).text to $input_file_dir/$(date +%Y%m%d%).html is successful!!&quot;
        iconv -f utf-8 -t gb2312 $input_file_dir/$(date +%Y%m%d).html &gt;$input_file_dir/game$(date +%Y%m%d).html

            if [ $? -eq 0 ];then
                    echo &quot;Html iconv to gb2312  finshed_time is  $(date +%Y%m%d%H%M%S)&quot;
            exit 0
            else
                    echo &quot;Html iconv to gb2312 is fail! at $(date +%Y%m%d%H%M)&quot;
               exit 1
            fi
    exit 0
    else
        echo &quot;$input_file_dir/$(date +%Y%m%d%).text to $input_file_dir/$(date +%Y%m%d%).html is fail!!&quot;
    exit 1
    fi
else
    echo &quot;Mysqldb output to $input_file_dir/$(date +%Y%m%d%).text is failed time is  $(date +%Y%m%d%H%M%S)&quot;
    exit 1
fi
#scp $input_file_dir/$(date +%Y%m%d%).html apbackup:/data/www/zabbix/apgame/
</code></pre>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.wokoweb.com/2016/08/14/mongdb数据导出/" data-id="cj4gn2lyv000zngjtw2364oax" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/NOSQL/">NOSQL</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mongo/">mongo</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/数据库/">数据库</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-nginx日志切割" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/07/15/nginx日志切割/" class="article-date">
  <time datetime="2016-07-15T00:00:00.000Z" itemprop="datePublished">2016-07-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/07/15/nginx日志切割/">nginx 日志切割</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="nginx日志分割脚本"><a href="#nginx日志分割脚本" class="headerlink" title="nginx日志分割脚本"></a>nginx日志分割脚本</h1><blockquote>
<p>访问量增多log日志文件过大，需要切割日志
    ﻿    ﻿    ﻿</p>
</blockquote>
<pre><code>#!/bin/bash
  ﻿savepath_log=&apos;/app/nginx/logs_back&apos;
﻿  nglogs=&apos;/app/nginx/logs&apos;
﻿  ﻿mkdir -p $savepath_log/$(date +%Y)/$(date +%m)
﻿  ﻿mv $nglogs/game.access.log  $savepath_log/$(date +%Y)/$(date +%m)/game.access.$(date +%Y%m%d).log
﻿  ﻿mv $nglogs/www.access.log  $savepath_log/$(date +%Y)/$(date +%m)/www.access.$(date +%Y%m%d).log
﻿  ﻿mv $nglogs/news.access.log  $savepath_log/$(date +%Y)/$(date +%m)/news.access.$(date +%Y%m%d).log
﻿  ﻿mv $nglogs/bbs.access.log  $savepath_log/$(date +%Y)/$(date +%m)/bbs.access.$(date +%Y%m%d).log
﻿  ﻿mv $nglogs/user.access.log  $savepath_log/$(date +%Y)/$(date +%m)/user.access.$(date +%Y%m%d).log
﻿  ﻿kill -USR1 `cat $nglogs/nginx.pid
</code></pre>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.wokoweb.com/2016/07/15/nginx日志切割/" data-id="cj4gn2lyx0013ngjtd2r96yih" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/logs/">logs</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nginx/">nginx</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-nginx负载均衡使用" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/06/22/nginx负载均衡使用/" class="article-date">
  <time datetime="2016-06-22T00:00:00.000Z" itemprop="datePublished">2016-06-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/06/22/nginx负载均衡使用/">nginx 负载均衡</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Nginx负载均衡"><a href="#Nginx负载均衡" class="headerlink" title="Nginx负载均衡"></a>Nginx负载均衡</h1><blockquote>
<p>nginx不单可以作为强大的web服务器，也可以作为一个反向代理服务器，而且nginx还可以按照调度规则实现动态、静态页面的分离，可以按照轮询、ip哈希、URL哈希、权重等多种方式对后端服务器做负载均衡，同时还支持后端服务器的健康检查。</p>
</blockquote>
<h2 id="Nginx负载均衡一些基础知识"><a href="#Nginx负载均衡一些基础知识" class="headerlink" title="Nginx负载均衡一些基础知识:"></a>Nginx负载均衡一些基础知识:</h2><h3 id="nginx-的-upstream目前支持-4-种方式的分配"><a href="#nginx-的-upstream目前支持-4-种方式的分配" class="headerlink" title="nginx 的 upstream目前支持 4 种方式的分配"></a>nginx 的 upstream目前支持 4 种方式的分配</h3><ul>
<li>轮询（默认）<pre><code>每个请求按时间顺序逐一分配到不同的后端服务器，如果后端服务器down掉，能自动剔除。
</code></pre></li>
<li>weight<pre><code>指定轮询几率，weight和访问比率成正比，用于后端服务器性能不均的情况。
</code></pre></li>
<li>ip_hash<pre><code>每个请求按访问ip的hash结果分配，这样每个访客固定访问一个后端服务器，可以解决session的问题。  
</code></pre></li>
<li>fair（第三方）<pre><code>按后端服务器的响应时间来分配请求，响应时间短的优先分配。  
</code></pre></li>
<li>url_hash（第三方）</li>
</ul>
<h2 id="配置使用"><a href="#配置使用" class="headerlink" title="配置使用"></a>配置使用</h2><h3 id="在http节点里添加"><a href="#在http节点里添加" class="headerlink" title="在http节点里添加:"></a>在http节点里添加:</h3><pre><code>#定义负载均衡设备的 Ip及设备状态
upstream myServer {   

    server 127.0.0.1:9090 down;
    server 127.0.0.1:8080 weight=2;
    server 127.0.0.1:6060;
    server 127.0.0.1:7070 backup;
}
</code></pre><blockquote>
<p>在需要使用负载的Server节点下添加</p>
</blockquote>
<pre><code>proxy_pass http://myServer;
</code></pre><h2 id="upstream-每个设备的状态"><a href="#upstream-每个设备的状态" class="headerlink" title="upstream 每个设备的状态:"></a>upstream 每个设备的状态:</h2><pre><code>down 表示单前的server暂时不参与负载
weight  默认为1.weight越大，负载的权重就越大。
max_fails ：允许请求失败的次数默认为1.当超过最大次数时，返回proxy_next_upstream 模块定义的错误
fail_timeout:max_fails 次失败后，暂停的时间。
backup： 其它所有的非backup机器down或者忙的时候，请求backup机器。所以这台机器压力会最轻。
Nginx还支持多组的负载均衡,可以配置多个upstream  来服务于不同的Server.

配置负载均衡比较简单,但是最关键的一个问题是怎么实现多台服务器之间session的共享
</code></pre><h2 id="配置方法介绍"><a href="#配置方法介绍" class="headerlink" title="配置方法介绍"></a>配置方法介绍</h2><ul>
<li>不使用session，换作cookie</li>
</ul>
<p>能把session改成cookie，就能避开session的一些弊端，在从前看的一本J2EE的书上，也指明在集群系统中不能用session，否则惹出祸端来就不好办。如果系统不复杂，就优先考虑能否将session去掉，改动起来非常麻烦的话，再用下面的办法。</p>
<ul>
<li>应用服务器自行实现共享</li>
</ul>
<p>asp.net可以用数据库或memcached来保存session，从而在asp.net本身建立了一个session集群，用这样的方式可以令 session保证稳定，即使某个节点有故障，session也不会丢失，适用于较为严格但请求量不高的场合。但是它的效率是不会很高的，不适用于对效率 要求高的场合。</p>
<p>以上两个办法都跟nginx没什么关系，下面来说说用nginx该如何处理：</p>
<ul>
<li>ip_hash</li>
</ul>
<p>nginx中的ip_hash技术能够将某个ip的请求定向到同一台后端，这样一来这个ip下的某个客户端和某个后端就能建立起稳固的session，ip_hash是在upstream配置中定义的：</p>
<pre><code>upstream backend {
  server 127.0.0.1:8080 ;
  server 127.0.0.1:9090 ;
   ip_hash;
}
</code></pre><h3 id="ip-hash是容易理解的，但是因为仅仅能用ip这个因子来分配后端，因此ip-hash是有缺陷的，不能在一些情况下使用："><a href="#ip-hash是容易理解的，但是因为仅仅能用ip这个因子来分配后端，因此ip-hash是有缺陷的，不能在一些情况下使用：" class="headerlink" title="ip_hash是容易理解的，但是因为仅仅能用ip这个因子来分配后端，因此ip_hash是有缺陷的，不能在一些情况下使用："></a>ip_hash是容易理解的，但是因为仅仅能用ip这个因子来分配后端，因此ip_hash是有缺陷的，不能在一些情况下使用：</h3><ul>
<li>nginx不是最前端的服务器。ip_hash要求nginx一定是最前端的服务器，否则nginx得不到正确ip，就不能根据ip作hash。譬如使用的是squid为最前端，那么nginx取ip时只能得到squid的服务器ip地址，用这个地址来作分流是肯定错乱的。</li>
<li><p>nginx的后端还有其它方式的负载均衡。假如nginx后端又有其它负载均衡，将请求又通过另外的方式分流了，那么某个客户端的请求肯定不能定位到同一台session应用服务器上。这么算起来，nginx后端只能直接指向应用服务器，或者再搭一个squid，然后指向应用服务器。最好的办法是用location作一次分流，将需要session的部分请求通过ip_hash分流，剩下的走其它后端去。</p>
</li>
<li><p>upstream_hash</p>
</li>
</ul>
<p>为了解决ip_hash的一些问题，可以使用upstream_hash这个第三方模块，这个模块多数情况下是用作url_hash的，但是并不妨碍将它用来做session共享：</p>
<p>假如前端是squid，他会将ip加入x_forwarded_for这个http_header里，用upstream_hash可以用这个头做因子，将请求定向到指定的后端：</p>
<p>可见这篇文档：<a href="http://www.sudone.com/nginx/nginx_url_hash.html" target="_blank" rel="external">http://www.sudone.com/nginx/nginx_url_hash.html</a></p>
<p>在文档中是使用$request_uri做因子，稍微改一下：</p>
<pre><code>hash   $http_x_forwarded_for;
</code></pre><p>这样就改成了利用x_forwarded_for这个头作因子，在nginx新版本中可支持读取cookie值，所以也可以改成：</p>
<pre><code>hash   $cookie_jsessionid;
</code></pre><p>假如在php中配置的session为无cookie方式，配合nginx自己的一个userid_module模块就可以用nginx自发一个cookie，可参见userid模块的英文文档：</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.wokoweb.com/2016/06/22/nginx负载均衡使用/" data-id="cj4gn2lyz0015ngjtxn1r2goq" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nginx/">nginx</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/负载均衡/">负载均衡</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-tomcat安装与配置" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/05/19/tomcat安装与配置/" class="article-date">
  <time datetime="2016-05-19T00:00:00.000Z" itemprop="datePublished">2016-05-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/05/19/tomcat安装与配置/">tomcat 安装配置使用</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="1-tomcat下载"><a href="#1-tomcat下载" class="headerlink" title="1.tomcat下载"></a>1.tomcat下载</h2><pre><code>wget http://www-eu.apache.org/dist/tomcat/tomcat-7/v7.0.68/bin/apache-tomcat-7.0.68.tar.gz
mv /opt/
tar -xf apache-tomcat-7.0.68.tar.gz -C /app/
</code></pre><h2 id="2-配置"><a href="#2-配置" class="headerlink" title="2.配置"></a>2.配置</h2><h3 id="2-1配置环境变量"><a href="#2-1配置环境变量" class="headerlink" title="2.1配置环境变量"></a>2.1配置环境变量</h3><p>vi /root/.bashrc</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.wokoweb.com/2016/05/19/tomcat安装与配置/" data-id="cj4gn2lzb001nngjtakhrqy90" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/tomcat/">tomcat</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-nginx配置技巧汇总" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/05/19/nginx配置技巧汇总/" class="article-date">
  <time datetime="2016-05-19T00:00:00.000Z" itemprop="datePublished">2016-05-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/05/19/nginx配置技巧汇总/">nginx 配置技巧汇总</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="nginx配置技巧汇总"><a href="#nginx配置技巧汇总" class="headerlink" title="nginx配置技巧汇总"></a>nginx配置技巧汇总</h1><p>本文记录了一些nginx作为反向代理和文件服务器的配置技巧和解决方案，持续更新</p>
<h2 id="Nginx作为文件服务"><a href="#Nginx作为文件服务" class="headerlink" title="Nginx作为文件服务"></a>Nginx作为文件服务</h2><blockquote>
<p>避免浏览器自动播放文件<br>有时对于图片、视频，浏览器会视能力，自动为用户显示或播放。这主要是由于Web服务器在返回文件本身数据的同时，返回了一些特殊的MIME类型，比如：image/jpeg（JPEG图像）,application/pdf（PDF文档）,video/mpeg（MPEG动画）。这些MIMIE类型实际上是告诉浏览器，文件数据到底是什么，这样浏览器就能更好的为用户展示数据。现在像图片、pdf、甚至是视频基本都是可以直接在浏览器中展示和播放的。但是有时，我们需要浏览器为用户下载文件而不是直接播放，而Nginx在默认配置下，会根据文件的后缀来匹配相应的MIME类型，并写入Response header，导致浏览器播放文件而不是下载，这时需要通过配置让Nginx返回的MIME类型为下面这个类型：</p>
</blockquote>
<pre><code>application/octet-stream
</code></pre><p>这个类型会让浏览器认为响应是普通的文件流，并提示用户下载文件。可以通过在Nginx的配置文件中做如下配置达到这样的目的：</p>
<pre><code>location /download/ {
    types        { }
    default_type application/octet-stream;
}
</code></pre><p>这样当Url路径中包含/download/时，MIME类型会被重置为application/octet-stream。另外，nginx自带的MIME类型映射表保存在conf/mime.types中。</p>
<h2 id="文件上传大小限制放开"><a href="#文件上传大小限制放开" class="headerlink" title="文件上传大小限制放开"></a>文件上传大小限制放开</h2><p>有的时候后端的Web-Server提供文件上传的服务，但是如果前端使用Nginx做反向代理时，会出现文件无法上传的问题，这可能是由于Ngxin默认对客户端请求的body的限制。因为，默认情况下Nginx对客户端请求的大小限制是1m，而上传的文件往往超过1m。可以通过修改如下配置项，来放宽这个限制：</p>
<pre><code>client_max_body_size 10m;
</code></pre><p>将这个值设置为0，可以取消这个限制。这个配置项可以用在http, server, location配置节中。详见client_max_body_size</p>
<h2 id="下载文件重命名"><a href="#下载文件重命名" class="headerlink" title="下载文件重命名"></a>下载文件重命名</h2><p>通常情况下，为了保证用户上传的文件在服务器的文件系统中不至于重名，一般会将文件名修改成guid后保存，并在数据库中保持guid与文件名的映射。此时，如果使用Nginx来提供对这些用户文件的下载功能的话，文件下载到用户浏览器，会以文件的guid名作为文件名，这显然是用户不想看到的。可以考虑用这个方案。 假设我们有一个文件的原始文件名为test.txt，对应的guid文件名是21EC2020-3AEA-1069-A2DD-08002B30309D.txt，文件的虚拟路径是/download/</p>
<p>使用服务器端编程语言，在输出的html中使用如下链接提供文件的下载：</p>
<pre><code>&lt;a href=&quot;/download/21EC2020-3AEA-1069-A2DD-08002B30309D.txt?n=test.txt&quot; target=&apos;_blank&apos;&gt;下载test.txt&lt;/a&gt;
可以看到，将原始文件名以QueryString的方式带在请求中，这样可以在Nginx端，利用$arg_name变量来取到这个QueryString的值，从而重写response header：

add_header Content-Disposition &quot;attachment; filename=$arg_n&quot;;
这会在response header中加入如下键值：

Content-Disposition: &quot;attachment; filename=test.txt&quot;;
经测试，无论是IE还是Chrome都可以支持这个header。

关于Content-Disposition，详见这里
</code></pre><p>关于Nginx的标准http模块的嵌入变量，详见这里</p>
<h2 id="提供flv视频播放"><a href="#提供flv视频播放" class="headerlink" title="提供flv视频播放"></a>提供flv视频播放</h2><p>使用jwplayer+Nginx能够实现视频在线播放，视频格式为flv。Nginx有一个flv模块ngx_http_flv_module，能够支持flv视频的快进播放。在安装Nginx的时候可能需要手动添加–with-http_flv_module，不过笔者使用的yum安装，自动带上了这个模块。</p>
<p>其实从这个模块的文档中可以看到，它只是能够处理start的带参数http请求，需要像下面这样配置：</p>
<pre><code>location ~ \.flv {
    root /var/video;
    flv;
}
</code></pre><p>从客户端播放器的角度看，还需要配置播放器的一些参数，以jwplayer为例：</p>
<pre><code>jwplayer(&quot;flashContent&quot;).setup({
    flashplayer: &quot;/jwplayer/player.swf&quot;,
    height: 270,
    width: 480,
    file: &quot;${file_url}.flv&quot;, //flv文件路径
    image:&quot;${file_url}.jpg&quot;, //缩略图
    streamer:&quot;start&quot;,
    provider: &quot;http&quot;, //有时可能是type:&quot;http&quot;
});
</code></pre><p>这里的关键参数是provider，用来告诉jwplayer使用http方式请求视频(还有其他协议，比如RTSP)，streamer参数是配合Nginx支持的start参数来设置的。</p>
<p>如果想要实现快进播放的话，还有一个关键点，就是视频需要包含有关键帧信息。关键帧信息其实就是一系列时间点+byte位。可以用yamdi为flv注入关键帧:</p>
<pre><code>yamdi -i a_without_meta.flv -o b_with_meta.flv
</code></pre><p>这样jwplayer能够根据快进的时间从关键帧信息中找到最近的关键帧的起始二进制点，并将这个byte作为start参数回传给Nginx。如果关键帧信息越密集的话，越占空间，但是快进也能够越精确：</p>
<p>//刚开始播放的时候，产生的http：<br>…/b_with_meta.flv?start=0<br>//用户快进后，产生的http：<br>…/b_with_meta.flv?start=37682252<br>附件批量打包下载<br>利用第三方模块mod_zip。详见利用Nginx第三方模块，实现附件打包下载</p>
<h2 id="Nginx作为反向代理"><a href="#Nginx作为反向代理" class="headerlink" title="Nginx作为反向代理"></a>Nginx作为反向代理</h2><p>一个IP多个域名<br>如果只有一个公网IP，但是网站功能需要划分为多个不同的子网站或者子域名，可以用Nginx来搭建反向代理来“复用”IP资源。假设有如下几个域名都是abc.com这个主域的：</p>
<pre><code>www.abc.com
image.abc.com
video.abc.com
</code></pre><p>首先在DNS出注册这3个域名同时指向同一个IP，Nginx作为前端的web服务器，让所有访问这个IP地址80端口的请求全部指向Nginx<br>然后，配置Nginx，根据域名将请求转发转发给内网的上游服务器，例如下面的配置：<br>      server {<br>          listen 80;<br>          server_name www.abc.com;<br>          location / {<br>                  proxy_pass <a href="http://192.168.1.100" target="_blank" rel="external">http://192.168.1.100</a>;<br>          }<br>       }</p>
<pre><code>server {
    listen 80;
    server_name image.abc.com;
    location / {
            alias /var/www/image;
    }
 }

server {
    listen 80;
    server_name video.abc.com;
    location / {
            proxy_pass http://192.168.1.100:8081/video;
    }
 }
</code></pre><p>在上述配置中，将三个域名分发给了不同的模块处理：</p>
<p>www.abc.com 分发给上游的<a href="http://192.168.1.100服务器处理" target="_blank" rel="external">http://192.168.1.100服务器处理</a><br>image.abc.com 则直接映射到了Nginx本机的一个目录<br>video.abc.com 分发给上游的<a href="http://192.168.1.100:8081/video服务器处理（video是上游web-server的某虚拟目录" target="_blank" rel="external">http://192.168.1.100:8081/video服务器处理（video是上游web-server的某虚拟目录</a>)</p>
<h2 id="上游服务器超时"><a href="#上游服务器超时" class="headerlink" title="上游服务器超时"></a>上游服务器超时</h2><blockquote>
<p>Nginx作为反向代理的时候，如果上游服务器处理时间过长的话，有时会返回504网关超时，从nginx的错误日志看出如果是upstream timed out，就表示是上游服务器处理时间过长，Nginx认为服务超时。Nginx在请求上游服务器时默认的超时时间为1分钟，可以通过调整proxy_read_timeout属性增加这个超时时间</p>
</blockquote>
<pre><code>proxy_read_timeout    180s;
</code></pre><p>默认的header过滤<br>Nginx默认对客户端的http请求进行很多验证，其中容易忽视的是header的验证，默认由下面两个配置节控制：</p>
<pre><code>underscores_in_headers on|off;
ignore_invalid_headers on|off;
underscores_in_headers off表示对包含有下划线(_)的header认为是不合法的，而ignore_invalid_headers on则表示对于不合法的header都过滤掉（无视掉）。如果在客户端自定义header的话，要注意尽量不要包含下划线，否则会碰到被Nginx过滤掉的问题。如果不可避免的要使用下划线的话，就考虑配置成这样的组合：

underscores_in_headers on;
ignore_invalid_headers off;
</code></pre><p>可以把上面的配置节设置在http或者server段中。</p>
<p>对于排查这个问题，可以通过将错误日志的告警级别调整到debug，并查看error日志，一般错误日志里面会包含有类似这样的信息</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.wokoweb.com/2016/05/19/nginx配置技巧汇总/" data-id="cj4gn2lz10017ngjthqcln60g" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nginx/">nginx</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-redis集群架构" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/04/05/redis集群架构/" class="article-date">
  <time datetime="2016-04-05T00:00:00.000Z" itemprop="datePublished">2016-04-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/05/redis集群架构/">redis 集群搭建</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="redis-集群搭建的方案"><a href="#redis-集群搭建的方案" class="headerlink" title="redis 集群搭建的方案"></a>redis 集群搭建的方案</h2><ul>
<li>redis  sentinel HA<br><img src="http://i.imgur.com/8juza5u.png" alt="redis sentinel   HA"></li>
<li>BDRP redis 分布式集群<br>*<br><img src="http://i.imgur.com/izkkSOS.jpg" alt="redis 分布式 集群架构"></li>
</ul>
<h2 id="redis-sentinel-集群安装"><a href="#redis-sentinel-集群安装" class="headerlink" title="redis sentinel 集群安装"></a>redis sentinel 集群安装</h2><ul>
<li>节点1 master sentinel1</li>
<li>节点2 slaver1 sentinel2</li>
<li>节点3 slaver2 sentinel3<h3 id="redis-安装方法"><a href="#redis-安装方法" class="headerlink" title="redis 安装方法"></a>redis 安装方法</h3><h4 id="1-下载软件包"><a href="#1-下载软件包" class="headerlink" title="1.下载软件包"></a>1.下载软件包</h4><code>wget http://download.redis.io/releases/redis-2.8.7.tar.gz</code></li>
</ul>
<h4 id="2-解压"><a href="#2-解压" class="headerlink" title="2.解压"></a>2.解压</h4><p><code>tar -xf redis-2.8.7.tar.gz</code></p>
<h4 id="3-安装"><a href="#3-安装" class="headerlink" title="3.安装"></a>3.安装</h4><pre><code>cd redis-2.8.7
mkdir -p  redis-dir
make prefix=redis-dir install
</code></pre><h3 id="redis配置"><a href="#redis配置" class="headerlink" title="redis配置"></a>redis配置</h3><ul>
<li>master配置文件</li>
</ul>
<p>默认配置即可</p>
<p>如需配置可参考如下配置:</p>
<pre><code>###master  redis.conf
####端口
port 6379
####授权密码，在安全的环境中可以不设置
requirepass test1        
masterauth test1
####注释指令重命名，若已配置则不需要修改
#rename-command
####开启AOF
appendonly yes
save “”
slave-read-only yes
</code></pre><ul>
<li>slaver  配置文件</li>
</ul>
<p>配置文件中添加</p>
<pre><code>slaveof  master_ip   master_port
</code></pre><p>其他配置与master一致即可</p>
<ul>
<li><p>sentinel 配置文件</p>
<p>  port 26379</p>
<p>  logfile “/app/redis/logs/sentinel.log”</p>
<p>  sentinel monitor mymaster 10.72.3.63 6379 2</p>
<p>  sentinel down-after-milliseconds mymaster 3000</p>
<p>  sentinel failover-timeout mymaster 60000</p>
<p>  sentinel client-reconfig-script mymaster /app/redis/failover.sh</p>
</li>
<li><p>sentinel 脚本文件</p>
<pre><code>#!/bin/sh
_DEBUG=&quot;on&quot;
DEBUGFILE=/tmp/sentinel_failover.log
VIP=&apos;10.125.125.30&apos;
MASTERIP=${6}
MASK=&apos;24&apos;
IFACE=&apos;eth0&apos;
MYIP=$(ip -4 -o addr show dev ${IFACE}| grep -v secondary| awk &apos;{split($4,a,&quot;/&quot;);print a[1]}&apos;)
DEBUG () {
        if [ &quot;$_DEBUG&quot; = &quot;on&quot; ]; then
                $@
        fi
}
set -e
DEBUG date &gt;&gt; ${DEBUGFILE}
DEBUG echo $@ &gt;&gt; ${DEBUGFILE}
DEBUG echo &quot;Master: ${MASTERIP} My IP: ${MYIP}&quot; &gt;&gt; ${DEBUGFILE}
if [ ${MASTERIP} = ${MYIP} ]; then
        if [ $(ip addr show ${IFACE} | grep ${VIP} | wc -l) = 0 ]; then
                sudo /sbin/ip addr add ${VIP}/${MASK} dev ${IFACE}
                DEBUG echo &quot;sudo /sbin/ip addr add ${VIP}/${MASK} dev ${IFACE}&quot; &gt;&gt; ${DEBUGFILE}
                sudo /usr/sbin/arping -q -c 3 -A ${VIP} -I ${INTERFACE}
        fi
        exit 0
else
        if [ $(ip addr show ${IFACE} | grep ${VIP} | wc -l) != 0 ]; then
                sudo /sbin/ip addr del ${VIP}/${MASK} dev ${IFACE}
                DEBUG echo &quot;sudo /sbin/ip addr del ${VIP}/${MASK} dev ${IFACE}&quot; &gt;&gt; ${DEBUGFILE}
        fi
        exit 0
fi
exit
</code></pre></li>
</ul>
<h3 id="启动步骤"><a href="#启动步骤" class="headerlink" title="启动步骤"></a>启动步骤</h3><ul>
<li>启动master之后slaver</li>
<li>启动sentinel</li>
</ul>
<p><code>[6539] 11 May 21:48:54.598 * +sentinel sentinel 10.72.3.63:26379 10.72.3.63 26379 @ mymaster</code></p>
<pre><code>10.72.3.62 6379

[6539] 11 May 22:45:58.762 # +sdown master mymaster 10.72.3.62 6379
</code></pre><h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>关闭master</p>
<pre><code>redis-cli -h master_IP  -p master_port shutdown
tail -f  sentinel.log
[6539] 11 May 22:46:00.072 # +switch-master mymaster 10.72.3.62 6379 10.72.3.63 6379
[6539] 11 May 22:46:00.072 * +slave slave 10.72.3.62:6379 10.72.3.62 6379 @ mymaster 10.72.3.63 6379
[6539] 11 May 22:46:03.111 # +sdown slave 10.72.3.62:6379 10.72.3.62 6379 @ mymaster 10.72.3.63 6379
[6539] 12 May 15:30:47.169 # +sdown sentinel 10.72.3.63:26379 10.72.3.63 26379 @ mymaster 10.72.3.63 6379
[6539] 12 May 15:30:47.878 # +sdown master mymaster 10.72.3.63 6379
</code></pre>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.wokoweb.com/2016/04/05/redis集群架构/" data-id="cj4gn2lz7001fngjtxu6uxf3m" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/redis/">redis</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/数据库/">数据库</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-NFS安装配置" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/03/05/NFS安装配置/" class="article-date">
  <time datetime="2016-03-05T00:00:00.000Z" itemprop="datePublished">2016-03-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/03/05/NFS安装配置/">NFS 安装与配置</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="NFS服务器端配置"><a href="#NFS服务器端配置" class="headerlink" title="NFS服务器端配置"></a>NFS服务器端配置</h1><pre><code>[root@&lt;hostname&gt; software] yum install nfs-utils
[root@&lt;hostname&gt; software] mkdir -p /sharedir/game /sharedir/user
[root@&lt;hostname&gt; software] chown -R 777 /sharedir
[root@&lt;hostname&gt; software] vi /etc/exports #填入如下内容
/sharedir/game 10.80.8.0/24(rw,no_root_squash)
/sharedir/user 10.80.8.0/24(rw,no_root_squash)
[root@&lt;hostname&gt; software] service rpcbind start
[root@&lt;hostname&gt; software] service nfs start
[root@&lt;hostname&gt; software] chkconfig rpcbind on
[root@&lt;hostname&gt; software] chkconfig nfs on
</code></pre><h1 id="NFS客户端配置"><a href="#NFS客户端配置" class="headerlink" title="NFS客户端配置"></a>NFS客户端配置</h1><pre><code>[root@&lt;hostname&gt; software] yum install nfs-utils
[root@&lt;hostname&gt; software] vi /etc/fstab #末尾追加如下内容
apbackup:/sharedir/game /data/www/game/web/static/uploadsnfsnodev,rw,rsize=32768,wsize=32768 0 0
apbackup:/sharedir/user /data/www/user/web/static/uploadsnfsnodev,rw,rsize=32768,wsize=32768 0 0
[root@&lt;hostname&gt; software] mount /data/www/game/web/static/uploads
[root@&lt;hostname&gt; software] mount/data/www/user/web/static/uploads
</code></pre>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.wokoweb.com/2016/03/05/NFS安装配置/" data-id="cj4gn2lyb0008ngjt06ql1et9" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/NFS/">NFS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/网络存储/">网络存储</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-vim删除" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/03/02/vim删除/" class="article-date">
  <time datetime="2016-03-02T00:00:00.000Z" itemprop="datePublished">2016-03-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/03/02/vim删除/">vim 删除</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="字符删除"><a href="#字符删除" class="headerlink" title="字符删除"></a>字符删除</h2><pre><code>x            删除光标所在处字符
X            删除光标所在前字符
这里没有什么可注意的地方，但需要说明一下的是

通常情况下，新手一旦着急便会按着x不动，从而达到删除一大块文本的目的
</code></pre><p>如果是头几天使用还好说，但从长久考虑，你还需要学习下面的删除命令</p>
<h2 id="单词删除"><a href="#单词删除" class="headerlink" title="单词删除"></a>单词删除</h2><pre><code>dw            删除到下一个单词开头
de            删除到本单词末尾
dE            删除到本单词末尾包括标点在内
db            删除到前一个单词
dB            删除到前一个单词包括标点在内
</code></pre><p>很明显，d是delete的缩写，而上面的x则是老式的清除意思</p>
<p>这里e表示往前删除一个单词，b表示往后删除一个单词，第一节中移动写的很清楚</p>
<p>要注意的是e b会忽略标点，如don’t，它们会把这当做三个单词don、‘ 和 t 来删除</p>
<p>而大写的E B则不会</p>
<h2 id="行删除"><a href="#行删除" class="headerlink" title="行删除"></a>行删除</h2><pre><code>dd            删除一整行
D d$          删除光标位置到本行结尾
d0            删除光标位置到本行开头
</code></pre><p>这三种用法是最好理解的</p>
<p>我一开始便说过，删除命令需要配合移动命令才能发挥更多作用</p>
<p>你可以看看第一节内容，然后自己尝试着删除一节或一段内容等</p>
<p>tips：3dd代表删除三行，聪明的你一定早就知道了</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.wokoweb.com/2016/03/02/vim删除/" data-id="cj4gn2lzd001pngjt7oo23f28" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/vim/">vim</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/快捷键/">快捷键</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-搭建VPN" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/09/01/搭建VPN/" class="article-date">
  <time datetime="2015-09-01T07:00:00.000Z" itemprop="datePublished">2015-09-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/09/01/搭建VPN/">pptpd VPN搭建脚本</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div></pre></td><td class="code"><pre><div class="line">#!/bin/bash</div><div class="line"></div><div class="line">function installVPN()&#123;</div><div class="line">	echo &quot;begin to install VPN services&quot;;</div><div class="line">	#check wether vps suppot ppp and tun</div><div class="line"></div><div class="line">	#判断centos版本</div><div class="line">	if grep -Eqi &quot;release 5.&quot; /etc/redhat-release; then</div><div class="line">		ver1=&apos;5&apos;</div><div class="line">	elif grep -Eqi &quot;release 6.&quot; /etc/redhat-release; then</div><div class="line">		ver1=&apos;6&apos;</div><div class="line">	elif grep -Eqi &quot;release 7.&quot; /etc/redhat-release; then</div><div class="line">		ver1=&apos;7&apos;</div><div class="line">	fi</div><div class="line"></div><div class="line">	yum install curl -y</div><div class="line">	yum install epel-release -y</div><div class="line"></div><div class="line">	if [ &quot;$ver1&quot; == &quot;7&quot; ]; then</div><div class="line">		#centos7要安装iptables把默认防火墙关了。</div><div class="line">		systemctl stop firewalld.service</div><div class="line">		systemctl disable firewalld.service</div><div class="line">		yum install iptables-services -y</div><div class="line">		#centos7需要加这个权限，否则不会开机自动执行</div><div class="line">		chmod +x /etc/rc.d/rc.local</div><div class="line">	fi</div><div class="line"></div><div class="line">	#先删除已经安装的pptpd和ppp</div><div class="line">	rm -rf /etc/pptpd.conf</div><div class="line">	rm -rf /etc/ppp</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">	yum install -y ppp pptpd</div><div class="line"></div><div class="line">	#写配置文件</div><div class="line">	mknod /dev/ppp c 108 0</div><div class="line">	echo 1 &gt; /proc/sys/net/ipv4/ip_forward                     </div><div class="line">	echo &quot;mknod /dev/ppp c 108 0&quot; &gt;&gt; /etc/rc.local</div><div class="line">	echo &quot;echo 1 &gt; /proc/sys/net/ipv4/ip_forward&quot; &gt;&gt; /etc/rc.local</div><div class="line">	echo &quot;localip 172.16.36.1&quot; &gt;&gt; /etc/pptpd.conf</div><div class="line">	echo &quot;remoteip 172.16.36.2-254&quot; &gt;&gt; /etc/pptpd.conf</div><div class="line">	echo &quot;ms-dns 8.8.8.8&quot; &gt;&gt; /etc/ppp/options.pptpd</div><div class="line">	echo &quot;ms-dns 8.8.4.4&quot; &gt;&gt; /etc/ppp/options.pptpd</div><div class="line"></div><div class="line">	pass=`openssl rand 6 -base64`</div><div class="line">	if [ &quot;$1&quot; != &quot;&quot; ]</div><div class="line">	then pass=$1</div><div class="line">	fi</div><div class="line"></div><div class="line">	echo &quot;vpn pptpd $&#123;pass&#125; *&quot; &gt;&gt; /etc/ppp/chap-secrets</div><div class="line"></div><div class="line">	iptables -t nat -A POSTROUTING -s 172.16.36.0/24 -j SNAT --to-source `curl ip.cn | awk -F &apos; &apos; &apos;&#123;print $2&#125;&apos; | awk -F &apos;：&apos; &apos;&#123;print $2&#125;&apos;`</div><div class="line">	iptables -A FORWARD -p tcp --syn -s 172.16.36.0/24 -j TCPMSS --set-mss 1356</div><div class="line">	iptables -I INPUT -p gre -j ACCEPT</div><div class="line">	iptables -I INPUT -p tcp -m tcp --dport 1723 -j ACCEPT</div><div class="line">	service iptables save</div><div class="line"></div><div class="line">	if [ &quot;ver1&quot; == &quot;7&quot; ]; then</div><div class="line">		systemctl enable iptables.service</div><div class="line">		systemctl enable pptpd.service</div><div class="line">		systemctl restart iptables.service</div><div class="line">		systemctl restart pptpd.service</div><div class="line">	else</div><div class="line">		chkconfig iptables on</div><div class="line">		chkconfig pptpd on</div><div class="line">		service iptables start</div><div class="line">		service pptpd start		</div><div class="line">	fi</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">	echo &quot;================================================&quot;</div><div class="line">	echo &quot;感谢使用www.91yun.org提供的pptpd vpn一键安装包&quot;</div><div class="line">	echo -e &quot;VPN的初始用户名是：\033[41;37m vpn  \033[0m, 初始密码是： \033[41;37m $&#123;pass&#125;  \033[0m&quot;</div><div class="line">	echo &quot;你也可以直接 vi /etc/ppp/chap-secrets修改用户名和密码&quot;</div><div class="line">	echo &quot;================================================&quot;</div><div class="line">&#125;</div><div class="line"></div><div class="line">function addVPNuser()&#123;</div><div class="line">	echo &quot;input user name:&quot;</div><div class="line">	read username</div><div class="line">	echo &quot;input password:&quot;</div><div class="line">	read userpassword</div><div class="line">	echo &quot;$&#123;username&#125; pptpd $&#123;userpassword&#125; *&quot; &gt;&gt; /etc/ppp/chap-secrets</div><div class="line">	service iptables restart</div><div class="line">	service pptpd start</div><div class="line">&#125;</div><div class="line"></div><div class="line">echo &quot;which do you want to?input the number.&quot;</div><div class="line">echo &quot;1. install VPN service&quot;</div><div class="line">echo &quot;2. add VPN user&quot;</div><div class="line">read num</div><div class="line"></div><div class="line">case &quot;$num&quot; in</div><div class="line">[1] ) (installVPN);;</div><div class="line">[2] ) (addVPNuser);;</div><div class="line">*) echo &quot;nothing,exit&quot;;;</div><div class="line">esac</div></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.wokoweb.com/2015/09/01/搭建VPN/" data-id="cj4gn2lzg001ungjtdr8skttq" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/VPN/">VPN</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pptpd/">pptpd</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/shell/">shell</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/page/3/">&laquo; __('prev')</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span>
  </nav>
</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Atom/">Atom</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Centos/">Centos</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ELK/">ELK</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/FTP/">FTP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NFS/">NFS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NOSQL/">NOSQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NetWork/">NetWork</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/">Redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SSL证书/">SSL证书</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/VPN/">VPN</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ansible/">ansible</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/awk/">awk</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/bacula/">bacula</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cachefilesd/">cachefilesd</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/centos7/">centos7</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/glusterfs/">glusterfs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/iptables/">iptables</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux-内核优化/">linux 内核优化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/logs/">logs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mongo/">mongo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/">mysql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx/">nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/openssl/">openssl</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/php/">php</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pptpd/">pptpd</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redis/">redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shell/">shell</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/supervisor/">supervisor</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tmux/">tmux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tomcat/">tomcat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vim/">vim</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/xtraback/">xtraback</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/分布式存储/">分布式存储</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/开发环境/">开发环境</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/快捷键/">快捷键</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/技术汇总/">技术汇总</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据库/">数据库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据提取/">数据提取</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/标准配置/">标准配置</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/硬盘/">硬盘</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/端口转发/">端口转发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/网络存储/">网络存储</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/负载均衡/">负载均衡</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/软件/">软件</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/集中备份软件/">集中备份软件</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/静态文件/">静态文件</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Atom/" style="font-size: 10px;">Atom</a> <a href="/tags/Centos/" style="font-size: 10px;">Centos</a> <a href="/tags/ELK/" style="font-size: 10px;">ELK</a> <a href="/tags/FTP/" style="font-size: 10px;">FTP</a> <a href="/tags/NFS/" style="font-size: 15px;">NFS</a> <a href="/tags/NOSQL/" style="font-size: 10px;">NOSQL</a> <a href="/tags/NetWork/" style="font-size: 10px;">NetWork</a> <a href="/tags/Redis/" style="font-size: 10px;">Redis</a> <a href="/tags/SSL证书/" style="font-size: 10px;">SSL证书</a> <a href="/tags/VPN/" style="font-size: 10px;">VPN</a> <a href="/tags/ansible/" style="font-size: 12.5px;">ansible</a> <a href="/tags/awk/" style="font-size: 10px;">awk</a> <a href="/tags/bacula/" style="font-size: 10px;">bacula</a> <a href="/tags/cachefilesd/" style="font-size: 10px;">cachefilesd</a> <a href="/tags/centos7/" style="font-size: 10px;">centos7</a> <a href="/tags/docker/" style="font-size: 10px;">docker</a> <a href="/tags/glusterfs/" style="font-size: 12.5px;">glusterfs</a> <a href="/tags/iptables/" style="font-size: 12.5px;">iptables</a> <a href="/tags/linux-内核优化/" style="font-size: 10px;">linux 内核优化</a> <a href="/tags/logs/" style="font-size: 10px;">logs</a> <a href="/tags/mongo/" style="font-size: 10px;">mongo</a> <a href="/tags/mysql/" style="font-size: 10px;">mysql</a> <a href="/tags/nginx/" style="font-size: 20px;">nginx</a> <a href="/tags/openssl/" style="font-size: 10px;">openssl</a> <a href="/tags/php/" style="font-size: 10px;">php</a> <a href="/tags/pptpd/" style="font-size: 10px;">pptpd</a> <a href="/tags/redis/" style="font-size: 10px;">redis</a> <a href="/tags/shell/" style="font-size: 17.5px;">shell</a> <a href="/tags/supervisor/" style="font-size: 10px;">supervisor</a> <a href="/tags/tmux/" style="font-size: 12.5px;">tmux</a> <a href="/tags/tomcat/" style="font-size: 10px;">tomcat</a> <a href="/tags/vim/" style="font-size: 10px;">vim</a> <a href="/tags/xtraback/" style="font-size: 12.5px;">xtraback</a> <a href="/tags/分布式存储/" style="font-size: 10px;">分布式存储</a> <a href="/tags/开发环境/" style="font-size: 10px;">开发环境</a> <a href="/tags/快捷键/" style="font-size: 10px;">快捷键</a> <a href="/tags/技术汇总/" style="font-size: 10px;">技术汇总</a> <a href="/tags/数据库/" style="font-size: 12.5px;">数据库</a> <a href="/tags/数据提取/" style="font-size: 10px;">数据提取</a> <a href="/tags/标准配置/" style="font-size: 10px;">标准配置</a> <a href="/tags/硬盘/" style="font-size: 10px;">硬盘</a> <a href="/tags/端口转发/" style="font-size: 10px;">端口转发</a> <a href="/tags/网络存储/" style="font-size: 12.5px;">网络存储</a> <a href="/tags/负载均衡/" style="font-size: 10px;">负载均衡</a> <a href="/tags/软件/" style="font-size: 10px;">软件</a> <a href="/tags/集中备份软件/" style="font-size: 10px;">集中备份软件</a> <a href="/tags/静态文件/" style="font-size: 10px;">静态文件</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">September 2015</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/06/28/mysql备份机制/">(no title)</a>
          </li>
        
          <li>
            <a href="/2017/04/29/suibi/">suibi</a>
          </li>
        
          <li>
            <a href="/2017/04/20/glusterfs详解/">glusterfs 详解</a>
          </li>
        
          <li>
            <a href="/2017/04/19/tmux/">tmux 使用配置</a>
          </li>
        
          <li>
            <a href="/2017/04/11/glusterfs集群搭建/">glusterfs集群搭建</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 kame<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>