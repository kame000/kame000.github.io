(window.webpackJsonp=window.webpackJsonp||[]).push([[118],{519:function(s,t,e){"use strict";e.r(t);var n=e(2),r=Object(n.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h2",{attrs:{id:"redis-集群方案"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#redis-集群方案"}},[s._v("#")]),s._v(" redis 集群方案")]),s._v(" "),t("h2",{attrs:{id:"_1-redis集群方案"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-redis集群方案"}},[s._v("#")]),s._v(" 1. Redis集群方案")]),s._v(" "),t("p",[t("code",[s._v("Redis Cluster")]),s._v(" 集群模式通常具有 "),t("strong",[s._v("高可用")]),s._v("、"),t("strong",[s._v("可扩展性")]),s._v("、"),t("strong",[s._v("分布式")]),s._v("、"),t("strong",[s._v("容错")]),s._v(" 等特性。"),t("code",[s._v("Redis")]),s._v(" 分布式方案一般有两种：")]),s._v(" "),t("h3",{attrs:{id:"_1-1-客户端分区方案"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-客户端分区方案"}},[s._v("#")]),s._v(" 1.1 客户端分区方案")]),s._v(" "),t("p",[t("strong",[s._v("客户端")]),s._v(" 就已经决定数据会被 "),t("strong",[s._v("存储")]),s._v(" 到哪个 "),t("code",[s._v("redis")]),s._v(" 节点或者从哪个 "),t("code",[s._v("redis")]),s._v(" 节点 "),t("strong",[s._v("读取数据")]),s._v("。其主要思想是采用 "),t("strong",[s._v("哈希算法")]),s._v(" 将 "),t("code",[s._v("Redis")]),s._v(" 数据的 "),t("code",[s._v("key")]),s._v(" 进行散列，通过 "),t("code",[s._v("hash")]),s._v(" 函数，特定的 "),t("code",[s._v("key")]),s._v("会 "),t("strong",[s._v("映射")]),s._v(" 到特定的 "),t("code",[s._v("Redis")]),s._v(" 节点上。")]),s._v(" "),t("p",[t("img",{attrs:{src:"http://img.sharkyun.com/blog/2019-07-19-001754.png",alt:"img"}})]),s._v(" "),t("p",[t("strong",[s._v("客户端分区方案")]),s._v(" 的代表为 "),t("code",[s._v("Redis Sharding")]),s._v("，"),t("code",[s._v("Redis Sharding")]),s._v(" 是 "),t("code",[s._v("Redis Cluster")]),s._v(" 出来之前，业界普遍使用的 "),t("code",[s._v("Redis")]),s._v(" "),t("strong",[s._v("多实例集群")]),s._v(" 方法。"),t("code",[s._v("Java")]),s._v(" 的 "),t("code",[s._v("Redis")]),s._v(" 客户端驱动库 "),t("code",[s._v("Jedis")]),s._v("，支持 "),t("code",[s._v("Redis Sharding")]),s._v(" 功能，即 "),t("code",[s._v("ShardedJedis")]),s._v(" 以及 "),t("strong",[s._v("结合缓存池")]),s._v(" 的 "),t("code",[s._v("ShardedJedisPool")]),s._v("。")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("优点")])])]),s._v(" "),t("p",[s._v("不使用 "),t("strong",[s._v("第三方中间件")]),s._v("，"),t("strong",[s._v("分区逻辑")]),s._v(" 可控，"),t("strong",[s._v("配置")]),s._v(" 简单，节点之间无关联，容易 "),t("strong",[s._v("线性扩展")]),s._v("，灵活性强。")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("缺点")])])]),s._v(" "),t("p",[t("strong",[s._v("客户端")]),s._v(" 无法 "),t("strong",[s._v("动态增删")]),s._v(" 服务节点，客户端需要自行维护 "),t("strong",[s._v("分发逻辑")]),s._v("，客户端之间 "),t("strong",[s._v("无连接共享")]),s._v("，会造成 "),t("strong",[s._v("连接浪费")]),s._v("。")]),s._v(" "),t("h3",{attrs:{id:"_1-2-代理分区方案"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-代理分区方案"}},[s._v("#")]),s._v(" 1.2. 代理分区方案")]),s._v(" "),t("p",[t("strong",[s._v("客户端")]),s._v(" 发送请求到一个 "),t("strong",[s._v("代理组件")]),s._v("，"),t("strong",[s._v("代理")]),s._v(" 解析 "),t("strong",[s._v("客户端")]),s._v(" 的数据，并将请求转发至正确的节点，最后将结果回复给客户端。")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("优点")]),s._v("：简化 "),t("strong",[s._v("客户端")]),s._v(" 的分布式逻辑，"),t("strong",[s._v("客户端")]),s._v(" 透明接入，切换成本低，代理的 "),t("strong",[s._v("转发")]),s._v(" 和 "),t("strong",[s._v("存储")]),s._v(" 分离。")]),s._v(" "),t("li",[t("strong",[s._v("缺点")]),s._v("：多了一层 "),t("strong",[s._v("代理层")]),s._v("，加重了 "),t("strong",[s._v("架构部署复杂度")]),s._v(" 和 "),t("strong",[s._v("性能损耗")]),s._v("。")])]),s._v(" "),t("p",[t("img",{attrs:{src:"http://img.sharkyun.com/blog/2019-07-19-001831.png",alt:"img"}})]),s._v(" "),t("p",[t("strong",[s._v("代理分区")]),s._v(" 主流实现的有方案有 "),t("code",[s._v("Twemproxy")]),s._v(" 和 "),t("code",[s._v("Codis")]),s._v("。")]),s._v(" "),t("h4",{attrs:{id:"_1-2-1-twemproxy"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-1-twemproxy"}},[s._v("#")]),s._v(" 1.2.1. Twemproxy")]),s._v(" "),t("p",[t("code",[s._v("Twemproxy")]),s._v(" 也叫 "),t("code",[s._v("nutcraker")]),s._v("，是 "),t("code",[s._v("twitter")]),s._v(" 开源的一个 "),t("code",[s._v("redis")]),s._v(" 和 "),t("code",[s._v("memcache")]),s._v(" 的 "),t("strong",[s._v("中间代理服务器")]),s._v(" 程序。"),t("code",[s._v("Twemproxy")]),s._v(" 作为 "),t("strong",[s._v("代理")]),s._v("，可接受来自多个程序的访问，按照 "),t("strong",[s._v("路由规则")]),s._v("，转发给后台的各个 "),t("code",[s._v("Redis")]),s._v(" 服务器，再原路返回。"),t("code",[s._v("Twemproxy")]),s._v(" 存在 "),t("strong",[s._v("单点故障")]),s._v(" 问题，需要结合 "),t("code",[s._v("Lvs")]),s._v(" 和 "),t("code",[s._v("Keepalived")]),s._v(" 做 "),t("strong",[s._v("高可用方案")]),s._v("。")]),s._v(" "),t("p",[t("img",{attrs:{src:"http://img.sharkyun.com/blog/2019-07-19-001902.png",alt:"img"}})]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("优点")]),s._v("：应用范围广，稳定性较高，中间代理层 "),t("strong",[s._v("高可用")]),s._v("。")]),s._v(" "),t("li",[t("strong",[s._v("缺点")]),s._v("：无法平滑地 "),t("strong",[s._v("水平扩容/缩容")]),s._v("，无 "),t("strong",[s._v("可视化管理界面")]),s._v("，运维不友好，出现故障，不能 "),t("strong",[s._v("自动转移")]),s._v("。")])]),s._v(" "),t("h4",{attrs:{id:"_1-2-2-codis"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-2-codis"}},[s._v("#")]),s._v(" 1.2.2. Codis")]),s._v(" "),t("p",[t("code",[s._v("Codis")]),s._v(" 是一个 "),t("strong",[s._v("分布式")]),s._v(" "),t("code",[s._v("Redis")]),s._v(" 解决方案，对于上层应用来说，连接 "),t("code",[s._v("Codis-Proxy")]),s._v(" 和直接连接 "),t("strong",[s._v("原生的")]),s._v(" "),t("code",[s._v("Redis-Server")]),s._v(" 没有的区别。"),t("code",[s._v("Codis")]),s._v(" 底层会 "),t("strong",[s._v("处理请求的转发")]),s._v("，不停机的进行 "),t("strong",[s._v("数据迁移")]),s._v(" 等工作。"),t("code",[s._v("Codis")]),s._v(" 采用了无状态的 "),t("strong",[s._v("代理层")]),s._v("，对于 "),t("strong",[s._v("客户端")]),s._v(" 来说，一切都是透明的。")]),s._v(" "),t("p",[t("img",{attrs:{src:"http://img.sharkyun.com/blog/2019-07-19-001929.png",alt:"img"}})]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("优点")])])]),s._v(" "),t("p",[s._v("实现了上层 "),t("code",[s._v("Proxy")]),s._v(" 和底层 "),t("code",[s._v("Redis")]),s._v(" 的 "),t("strong",[s._v("高可用")]),s._v("，"),t("strong",[s._v("数据分片")]),s._v(" 和 "),t("strong",[s._v("自动平衡")]),s._v("，提供 "),t("strong",[s._v("命令行接口")]),s._v(" 和 "),t("code",[s._v("RESTful API")]),s._v("，提供 "),t("strong",[s._v("监控")]),s._v(" 和 "),t("strong",[s._v("管理")]),s._v(" 界面，可以动态 "),t("strong",[s._v("添加")]),s._v(" 和 "),t("strong",[s._v("删除")]),s._v(" "),t("code",[s._v("Redis")]),s._v(" 节点。")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("缺点")])])]),s._v(" "),t("p",[t("strong",[s._v("部署架构")]),s._v(" 和 "),t("strong",[s._v("配置")]),s._v(" 复杂，不支持 "),t("strong",[s._v("跨机房")]),s._v(" 和 "),t("strong",[s._v("多租户")]),s._v("，不支持 "),t("strong",[s._v("鉴权管理")]),s._v("。")]),s._v(" "),t("h3",{attrs:{id:"_1-3-查询路由方案"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-查询路由方案"}},[s._v("#")]),s._v(" 1.3. 查询路由方案")]),s._v(" "),t("p",[t("strong",[s._v("客户端随机地")]),s._v(" 请求任意一个 "),t("code",[s._v("Redis")]),s._v(" 实例，然后由 "),t("code",[s._v("Redis")]),s._v(" 将请求 "),t("strong",[s._v("转发")]),s._v(" 给 "),t("strong",[s._v("正确")]),s._v(" 的 "),t("code",[s._v("Redis")]),s._v(" 节点。"),t("code",[s._v("Redis Cluster")]),s._v(" 实现了一种 "),t("strong",[s._v("混合形式")]),s._v(" 的 "),t("strong",[s._v("查询路由")]),s._v("，但并不是 "),t("strong",[s._v("直接")]),s._v(" 将请求从一个 "),t("code",[s._v("Redis")]),s._v(" 节点 "),t("strong",[s._v("转发")]),s._v(" 到另一个 "),t("code",[s._v("Redis")]),s._v(" 节点，而是在 "),t("strong",[s._v("客户端")]),s._v(" 的帮助下直接 "),t("strong",[s._v("重定向")]),s._v("（ "),t("code",[s._v("redirected")]),s._v("）到正确的 "),t("code",[s._v("Redis")]),s._v(" 节点。")]),s._v(" "),t("p",[t("img",{attrs:{src:"http://img.sharkyun.com/blog/2019-07-19-001949.png",alt:"img"}})]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("优点")])])]),s._v(" "),t("p",[t("strong",[s._v("无中心节点")]),s._v("，数据按照 "),t("strong",[s._v("槽")]),s._v(" 存储分布在多个 "),t("code",[s._v("Redis")]),s._v(" 实例上，可以平滑的进行节点 "),t("strong",[s._v("扩容/缩容")]),s._v("，支持 "),t("strong",[s._v("高可用")]),s._v(" 和 "),t("strong",[s._v("自动故障转移")]),s._v("，运维成本低。")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("缺点")])])]),s._v(" "),t("p",[s._v("严重依赖 "),t("code",[s._v("Redis-trib")]),s._v(" 工具，缺乏 "),t("strong",[s._v("监控管理")]),s._v("，需要依赖 "),t("code",[s._v("Smart Client")]),s._v(" ("),t("strong",[s._v("维护连接")]),s._v("，"),t("strong",[s._v("缓存路由表")]),s._v("，"),t("code",[s._v("MultiOp")]),s._v(" 和 "),t("code",[s._v("Pipeline")]),s._v(" 支持)。"),t("code",[s._v("Failover")]),s._v(" 节点的 "),t("strong",[s._v("检测过慢")]),s._v("，不如 "),t("strong",[s._v("中心节点")]),s._v(" "),t("code",[s._v("ZooKeeper")]),s._v(" 及时。"),t("code",[s._v("Gossip")]),s._v(" 消息具有一定开销。无法根据统计区分 "),t("strong",[s._v("冷热数据")]),s._v("。")]),s._v(" "),t("h2",{attrs:{id:"_2-数据分布"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-数据分布"}},[s._v("#")]),s._v(" 2. 数据分布")]),s._v(" "),t("h3",{attrs:{id:"_2-1-数据分布理论"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-数据分布理论"}},[s._v("#")]),s._v(" 2.1. 数据分布理论")]),s._v(" "),t("p",[t("strong",[s._v("分布式数据库")]),s._v(" 首先要解决把 "),t("strong",[s._v("整个数据集")]),s._v(" 按照 "),t("strong",[s._v("分区规则")]),s._v(" 映射到 "),t("strong",[s._v("多个节点")]),s._v(" 的问题，即把 "),t("strong",[s._v("数据集")]),s._v(" 划分到 "),t("strong",[s._v("多个节点")]),s._v(" 上，每个节点负责 "),t("strong",[s._v("整体数据")]),s._v(" 的一个 "),t("strong",[s._v("子集")]),s._v("。")]),s._v(" "),t("p",[t("img",{attrs:{src:"http://img.sharkyun.com/blog/2019-07-19-002008.png",alt:"img"}})]),s._v(" "),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"title"}),t("p",[s._v("数据分布通常有 "),t("strong",[s._v("哈希分区")]),s._v(" 和 "),t("strong",[s._v("顺序分区")]),s._v(" 两种方式，对比如下：")])]),t("table",[t("thead",[t("tr",[t("th",{staticStyle:{"text-align":"left"}},[s._v("分区方式")]),s._v(" "),t("th",{staticStyle:{"text-align":"left"}},[s._v("特点")]),s._v(" "),t("th",{staticStyle:{"text-align":"left"}},[s._v("相关产品")])])]),s._v(" "),t("tbody",[t("tr",[t("td",{staticStyle:{"text-align":"left"}},[s._v("哈希分区")]),s._v(" "),t("td",{staticStyle:{"text-align":"left"}},[s._v("离散程度好，数据分布与业务无关，无法顺序访问")]),s._v(" "),t("td",{staticStyle:{"text-align":"left"}},[s._v("Redis Cluster，Cassandra，Dynamo")])]),s._v(" "),t("tr",[t("td",{staticStyle:{"text-align":"left"}},[s._v("顺序分区")]),s._v(" "),t("td",{staticStyle:{"text-align":"left"}},[s._v("离散程度易倾斜，数据分布与业务相关，可以顺序访问")]),s._v(" "),t("td",{staticStyle:{"text-align":"left"}},[s._v("BigTable，HBase，Hypertable")])])])]),s._v(" "),t("p",[s._v("由于 "),t("code",[s._v("Redis Cluster")]),s._v(" 采用 "),t("strong",[s._v("哈希分区规则")]),s._v("，这里重点讨论 "),t("strong",[s._v("哈希分区")]),s._v("。常见的 "),t("strong",[s._v("哈希分区")]),s._v(" 规则有几种，下面分别介绍：")]),s._v(" "),t("h4",{attrs:{id:"_2-1-1-节点取余分区"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-1-节点取余分区"}},[s._v("#")]),s._v(" 2.1.1. 节点取余分区")]),s._v(" "),t("p",[s._v("使用特定的数据，如 "),t("code",[s._v("Redis")]),s._v(" 的 "),t("strong",[s._v("键")]),s._v(" 或 "),t("strong",[s._v("用户")]),s._v(" "),t("code",[s._v("ID")]),s._v("，再根据 "),t("strong",[s._v("节点数量")]),s._v(" "),t("code",[s._v("N")]),s._v(" 使用公式："),t("code",[s._v("hash（key）% N")]),s._v(" 计算出 "),t("strong",[s._v("哈希值")]),s._v("，用来决定数据 "),t("strong",[s._v("映射")]),s._v(" 到哪一个节点上。")]),s._v(" "),t("p",[t("img",{attrs:{src:"http://img.sharkyun.com/blog/2019-07-19-002042.png",alt:"img"}})]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("优点")])])]),s._v(" "),t("p",[s._v("这种方式的突出优点是 "),t("strong",[s._v("简单性")]),s._v("，常用于 "),t("strong",[s._v("数据库")]),s._v(" 的 "),t("strong",[s._v("分库分表规则")]),s._v("。一般采用 "),t("strong",[s._v("预分区")]),s._v(" 的方式，提前根据 "),t("strong",[s._v("数据量")]),s._v(" 规划好 "),t("strong",[s._v("分区数")]),s._v("，比如划分为 "),t("code",[s._v("512")]),s._v(" 或 "),t("code",[s._v("1024")]),s._v(" 张表，保证可支撑未来一段时间的 "),t("strong",[s._v("数据容量")]),s._v("，再根据 "),t("strong",[s._v("负载情况")]),s._v(" 将 "),t("strong",[s._v("表")]),s._v(" 迁移到其他 "),t("strong",[s._v("数据库")]),s._v(" 中。扩容时通常采用 "),t("strong",[s._v("翻倍扩容")]),s._v("，避免 "),t("strong",[s._v("数据映射")]),s._v(" 全部被 "),t("strong",[s._v("打乱")]),s._v("，导致 "),t("strong",[s._v("全量迁移")]),s._v(" 的情况。")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("缺点")])])]),s._v(" "),t("p",[s._v("当 "),t("strong",[s._v("节点数量")]),s._v(" 变化时，如 "),t("strong",[s._v("扩容")]),s._v(" 或 "),t("strong",[s._v("收缩")]),s._v(" 节点，数据节点 "),t("strong",[s._v("映射关系")]),s._v(" 需要重新计算，会导致数据的 "),t("strong",[s._v("重新迁移")]),s._v("。")]),s._v(" "),t("h4",{attrs:{id:"_2-1-2-一致性哈希分区"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-2-一致性哈希分区"}},[s._v("#")]),s._v(" 2.1.2. 一致性哈希分区")]),s._v(" "),t("p",[t("strong",[s._v("一致性哈希")]),s._v(" 可以很好的解决 "),t("strong",[s._v("稳定性问题")]),s._v("，可以将所有的 "),t("strong",[s._v("存储节点")]),s._v(" 排列在 "),t("strong",[s._v("收尾相接")]),s._v(" 的 "),t("code",[s._v("Hash")]),s._v(" 环上，每个 "),t("code",[s._v("key")]),s._v(" 在计算 "),t("code",[s._v("Hash")]),s._v(" 后会 "),t("strong",[s._v("顺时针")]),s._v(" 找到 "),t("strong",[s._v("临接")]),s._v(" 的 "),t("strong",[s._v("存储节点")]),s._v(" 存放。而当有节点 "),t("strong",[s._v("加入")]),s._v(" 或 "),t("strong",[s._v("退出")]),s._v(" 时，仅影响该节点在 "),t("code",[s._v("Hash")]),s._v(" 环上 "),t("strong",[s._v("顺时针相邻")]),s._v(" 的 "),t("strong",[s._v("后续节点")]),s._v("。")]),s._v(" "),t("p",[t("img",{attrs:{src:"http://img.sharkyun.com/blog/2019-07-19-002057.png",alt:"img"}})]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("优点")])])]),s._v(" "),t("p",[t("strong",[s._v("加入")]),s._v(" 和 "),t("strong",[s._v("删除")]),s._v(" 节点只影响 "),t("strong",[s._v("哈希环")]),s._v(" 中 "),t("strong",[s._v("顺时针方向")]),s._v(" 的 "),t("strong",[s._v("相邻的节点")]),s._v("，对其他节点无影响。")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("缺点")])])]),s._v(" "),t("p",[t("strong",[s._v("加减节点")]),s._v(" 会造成 "),t("strong",[s._v("哈希环")]),s._v(" 中部分数据 "),t("strong",[s._v("无法命中")]),s._v("。当使用 "),t("strong",[s._v("少量节点")]),s._v(" 时，"),t("strong",[s._v("节点变化")]),s._v(" 将大范围影响 "),t("strong",[s._v("哈希环")]),s._v(" 中 "),t("strong",[s._v("数据映射")]),s._v("，不适合 "),t("strong",[s._v("少量数据节点")]),s._v(" 的分布式方案。"),t("strong",[s._v("普通")]),s._v(" 的 "),t("strong",[s._v("一致性哈希分区")]),s._v(" 在增减节点时需要 "),t("strong",[s._v("增加一倍")]),s._v(" 或 "),t("strong",[s._v("减去一半")]),s._v(" 节点才能保证 "),t("strong",[s._v("数据")]),s._v(" 和 "),t("strong",[s._v("负载的均衡")]),s._v("。")]),s._v(" "),t("blockquote",[t("p",[t("strong",[s._v("注意")]),s._v("：因为 "),t("strong",[s._v("一致性哈希分区")]),s._v(" 的这些缺点，一些分布式系统采用 "),t("strong",[s._v("虚拟槽")]),s._v(" 对 "),t("strong",[s._v("一致性哈希")]),s._v(" 进行改进，比如 "),t("code",[s._v("Dynamo")]),s._v(" 系统。")])]),s._v(" "),t("h4",{attrs:{id:"_2-1-3-虚拟槽分区"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-3-虚拟槽分区"}},[s._v("#")]),s._v(" 2.1.3. 虚拟槽分区")]),s._v(" "),t("p",[t("strong",[s._v("虚拟槽分区")]),s._v(" 巧妙地使用了 "),t("strong",[s._v("哈希空间")]),s._v("，使用 "),t("strong",[s._v("分散度良好")]),s._v(" 的 "),t("strong",[s._v("哈希函数")]),s._v(" 把所有数据 "),t("strong",[s._v("映射")]),s._v(" 到一个 "),t("strong",[s._v("固定范围")]),s._v(" 的 "),t("strong",[s._v("整数集合")]),s._v(" 中，整数定义为 "),t("strong",[s._v("槽")]),s._v("（"),t("code",[s._v("slot")]),s._v("）。这个范围一般 "),t("strong",[s._v("远远大于")]),s._v(" 节点数，比如 "),t("code",[s._v("Redis Cluster")]),s._v(" 槽范围是 "),t("code",[s._v("0 ~ 16383")]),s._v("。"),t("strong",[s._v("槽")]),s._v(" 是集群内 "),t("strong",[s._v("数据管理")]),s._v(" 和 "),t("strong",[s._v("迁移")]),s._v(" 的 "),t("strong",[s._v("基本单位")]),s._v("。采用 "),t("strong",[s._v("大范围槽")]),s._v(" 的主要目的是为了方便 "),t("strong",[s._v("数据拆分")]),s._v(" 和 "),t("strong",[s._v("集群扩展")]),s._v("。每个节点会负责 "),t("strong",[s._v("一定数量的槽")]),s._v("，如图所示：")]),s._v(" "),t("p",[t("img",{attrs:{src:"http://img.sharkyun.com/blog/2019-07-19-002120.png",alt:"img"}})]),s._v(" "),t("p",[s._v("当前集群有 "),t("code",[s._v("5")]),s._v(" 个节点，每个节点平均大约负责 "),t("code",[s._v("3276")]),s._v(" 个 "),t("strong",[s._v("槽")]),s._v("。由于采用 "),t("strong",[s._v("高质量")]),s._v(" 的 "),t("strong",[s._v("哈希算法")]),s._v("，每个槽所映射的数据通常比较 "),t("strong",[s._v("均匀")]),s._v("，将数据平均划分到 "),t("code",[s._v("5")]),s._v(" 个节点进行 "),t("strong",[s._v("数据分区")]),s._v("。"),t("code",[s._v("Redis Cluster")]),s._v(" 就是采用 "),t("strong",[s._v("虚拟槽分区")]),s._v("。")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("节点1")]),s._v("： 包含 "),t("code",[s._v("0")]),s._v(" 到 "),t("code",[s._v("3276")]),s._v(" 号哈希槽。")]),s._v(" "),t("li",[t("strong",[s._v("节点2")]),s._v("：包含 "),t("code",[s._v("3277")]),s._v("  到 "),t("code",[s._v("6553")]),s._v(" 号哈希槽。")]),s._v(" "),t("li",[t("strong",[s._v("节点3")]),s._v("：包含 "),t("code",[s._v("6554")]),s._v(" 到 "),t("code",[s._v("9830")]),s._v(" 号哈希槽。")]),s._v(" "),t("li",[t("strong",[s._v("节点4")]),s._v("：包含 "),t("code",[s._v("9831")]),s._v(" 到 "),t("code",[s._v("13107")]),s._v(" 号哈希槽。")]),s._v(" "),t("li",[t("strong",[s._v("节点5")]),s._v("：包含 "),t("code",[s._v("13108")]),s._v(" 到 "),t("code",[s._v("16383")]),s._v(" 号哈希槽。")])]),s._v(" "),t("p",[s._v("这种结构很容易 "),t("strong",[s._v("添加")]),s._v(" 或者 "),t("strong",[s._v("删除")]),s._v(" 节点。如果 "),t("strong",[s._v("增加")]),s._v(" 一个节点 "),t("code",[s._v("6")]),s._v("，就需要从节点 "),t("code",[s._v("1 ~ 5")]),s._v(" 获得部分 "),t("strong",[s._v("槽")]),s._v(" 分配到节点 "),t("code",[s._v("6")]),s._v(" 上。如果想 "),t("strong",[s._v("移除")]),s._v(" 节点 "),t("code",[s._v("1")]),s._v("，需要将节点 "),t("code",[s._v("1")]),s._v(" 中的 "),t("strong",[s._v("槽")]),s._v(" 移到节点 "),t("code",[s._v("2 ~ 5")]),s._v(" 上，然后将 "),t("strong",[s._v("没有任何槽")]),s._v(" 的节点 "),t("code",[s._v("1")]),s._v(" 从集群中 "),t("strong",[s._v("移除")]),s._v(" 即可。")]),s._v(" "),t("blockquote",[t("p",[s._v("由于从一个节点将 "),t("strong",[s._v("哈希槽")]),s._v(" 移动到另一个节点并不会 "),t("strong",[s._v("停止服务")]),s._v("，所以无论 "),t("strong",[s._v("添加删除")]),s._v(" 或者 "),t("strong",[s._v("改变")]),s._v(" 某个节点的 "),t("strong",[s._v("哈希槽的数量")]),s._v(" 都不会造成 "),t("strong",[s._v("集群不可用")]),s._v(" 的状态.")])]),s._v(" "),t("h3",{attrs:{id:"_2-2-redis的数据分区"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-redis的数据分区"}},[s._v("#")]),s._v(" 2.2. Redis的数据分区")]),s._v(" "),t("p",[t("code",[s._v("Redis Cluster")]),s._v(" 采用 "),t("strong",[s._v("虚拟槽分区")]),s._v("，所有的 "),t("strong",[s._v("键")]),s._v(" 根据 "),t("strong",[s._v("哈希函数")]),s._v(" 映射到 "),t("code",[s._v("0~16383")]),s._v(" 整数槽内，计算公式："),t("code",[s._v("slot = CRC16（key）& 16383")]),s._v("。每个节点负责维护一部分槽以及槽所映射的 "),t("strong",[s._v("键值数据")]),s._v("，如图所示：")]),s._v(" "),t("p",[t("img",{attrs:{src:"http://img.sharkyun.com/blog/2019-07-19-002138.png",alt:"img"}})]),s._v(" "),t("h4",{attrs:{id:"_2-2-1-redis虚拟槽分区的特点"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-1-redis虚拟槽分区的特点"}},[s._v("#")]),s._v(" 2.2.1. Redis虚拟槽分区的特点")]),s._v(" "),t("ul",[t("li",[s._v("解耦 "),t("strong",[s._v("数据")]),s._v(" 和 "),t("strong",[s._v("节点")]),s._v(" 之间的关系，简化了节点 "),t("strong",[s._v("扩容")]),s._v(" 和 "),t("strong",[s._v("收缩")]),s._v(" 难度。")]),s._v(" "),t("li",[t("strong",[s._v("节点自身")]),s._v(" 维护槽的 "),t("strong",[s._v("映射关系")]),s._v("，不需要 "),t("strong",[s._v("客户端")]),s._v(" 或者 "),t("strong",[s._v("代理服务")]),s._v(" 维护 "),t("strong",[s._v("槽分区元数据")]),s._v("。")]),s._v(" "),t("li",[s._v("支持 "),t("strong",[s._v("节点")]),s._v("、"),t("strong",[s._v("槽")]),s._v("、"),t("strong",[s._v("键")]),s._v(" 之间的 "),t("strong",[s._v("映射查询")]),s._v("，用于 "),t("strong",[s._v("数据路由")]),s._v("、"),t("strong",[s._v("在线伸缩")]),s._v(" 等场景。")])]),s._v(" "),t("h3",{attrs:{id:"_2-3-redis集群的功能限制"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-redis集群的功能限制"}},[s._v("#")]),s._v(" 2.3. Redis集群的功能限制")]),s._v(" "),t("p",[t("code",[s._v("Redis")]),s._v(" 集群相对 "),t("strong",[s._v("单机")]),s._v(" 在功能上存在一些限制，需要 "),t("strong",[s._v("开发人员")]),s._v(" 提前了解，在使用时做好规避。")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("key")]),s._v(" "),t("strong",[s._v("批量操作")]),s._v(" 支持有限。")])]),s._v(" "),t("p",[s._v("类似 "),t("code",[s._v("mset")]),s._v("、"),t("code",[s._v("mget")]),s._v(" 操作，目前只支持对具有相同 "),t("code",[s._v("slot")]),s._v(" 值的 "),t("code",[s._v("key")]),s._v(" 执行 "),t("strong",[s._v("批量操作")]),s._v("。对于 "),t("strong",[s._v("映射为不同")]),s._v(" "),t("code",[s._v("slot")]),s._v(" 值的 "),t("code",[s._v("key")]),s._v(" 由于执行 "),t("code",[s._v("mget")]),s._v("、"),t("code",[s._v("mget")]),s._v(" 等操作可能存在于多个节点上，因此不被支持。")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("key")]),s._v(" "),t("strong",[s._v("事务操作")]),s._v(" 支持有限。")])]),s._v(" "),t("p",[s._v("只支持 "),t("strong",[s._v("多")]),s._v(" "),t("code",[s._v("key")]),s._v(" 在 "),t("strong",[s._v("同一节点上")]),s._v(" 的 "),t("strong",[s._v("事务操作")]),s._v("，当多个 "),t("code",[s._v("key")]),s._v(" 分布在 "),t("strong",[s._v("不同")]),s._v(" 的节点上时 "),t("strong",[s._v("无法")]),s._v(" 使用事务功能。")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("key")]),s._v(" 作为 "),t("strong",[s._v("数据分区")]),s._v(" 的最小粒度")])]),s._v(" "),t("p",[s._v("不能将一个 "),t("strong",[s._v("大的键值")]),s._v(" 对象如 "),t("code",[s._v("hash")]),s._v("、"),t("code",[s._v("list")]),s._v(" 等映射到 "),t("strong",[s._v("不同的节点")]),s._v("。")]),s._v(" "),t("ul",[t("li",[s._v("不支持 "),t("strong",[s._v("多数据库空间")])])]),s._v(" "),t("p",[t("strong",[s._v("单机")]),s._v(" 下的 "),t("code",[s._v("Redis")]),s._v(" 可以支持 "),t("code",[s._v("16")]),s._v(" 个数据库（"),t("code",[s._v("db0 ~ db15")]),s._v("），"),t("strong",[s._v("集群模式")]),s._v(" 下只能使用 "),t("strong",[s._v("一个")]),s._v(" 数据库空间，即 "),t("code",[s._v("db0")]),s._v("。")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("复制结构")]),s._v(" 只支持一层")])]),s._v(" "),t("p",[t("strong",[s._v("从节点")]),s._v(" 只能复制 "),t("strong",[s._v("主节点")]),s._v("，不支持 "),t("strong",[s._v("嵌套树状复制")]),s._v(" 结构。")]),s._v(" "),t("h2",{attrs:{id:"_3-redis集群搭建"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-redis集群搭建"}},[s._v("#")]),s._v(" 3. Redis集群搭建")]),s._v(" "),t("p",[t("code",[s._v("Redis-Cluster")]),s._v(" 是 "),t("code",[s._v("Redis")]),s._v(" 官方的一个 "),t("strong",[s._v("高可用")]),s._v(" 解决方案，"),t("code",[s._v("Cluster")]),s._v(" 中的 "),t("code",[s._v("Redis")]),s._v(" 共有 "),t("code",[s._v("2^14（16384）")]),s._v(" 个 "),t("code",[s._v("slot")]),s._v(" "),t("strong",[s._v("槽")]),s._v("。创建 "),t("code",[s._v("Cluster")]),s._v(" 后，"),t("strong",[s._v("槽")]),s._v(" 会 "),t("strong",[s._v("平均分配")]),s._v(" 到每个 "),t("code",[s._v("Redis")]),s._v(" 节点上。")]),s._v(" "),t("p",[s._v("下面介绍一下本机启动 "),t("code",[s._v("6")]),s._v(" 个 "),t("code",[s._v("Redis")]),s._v(" 的 "),t("strong",[s._v("集群服务")]),s._v("，并使用 "),t("code",[s._v("redis-trib.rb")]),s._v(" 创建 "),t("strong",[s._v("3主3从")]),s._v(" 的 "),t("strong",[s._v("集群")]),s._v("。搭建集群工作需要以下三个步骤：")]),s._v(" "),t("h3",{attrs:{id:"_3-1-准备节点"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-准备节点"}},[s._v("#")]),s._v(" 3.1. 准备节点")]),s._v(" "),t("p",[t("code",[s._v("Redis")]),s._v(" 集群一般由 "),t("strong",[s._v("多个节点")]),s._v(" 组成，节点数量至少为 "),t("code",[s._v("6")]),s._v(" 个，才能保证组成 "),t("strong",[s._v("完整高可用")]),s._v(" 的集群。每个节点需要 "),t("strong",[s._v("开启配置")]),s._v(" "),t("code",[s._v("cluster-enabled yes")]),s._v("，让 "),t("code",[s._v("Redis")]),s._v(" 运行在 "),t("strong",[s._v("集群模式")]),s._v(" 下。")]),s._v(" "),t("p",[t("code",[s._v("Redis")]),s._v(" 集群的节点规划如下：")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",{staticStyle:{"text-align":"left"}},[s._v("节点名称")]),s._v(" "),t("th",{staticStyle:{"text-align":"left"}},[s._v("端口号")]),s._v(" "),t("th",{staticStyle:{"text-align":"left"}},[s._v("是主是从")]),s._v(" "),t("th",[s._v("所属主节点")])])]),s._v(" "),t("tbody",[t("tr",[t("td",{staticStyle:{"text-align":"left"}},[s._v("redis-6379")]),s._v(" "),t("td",{staticStyle:{"text-align":"left"}},[s._v("6379")]),s._v(" "),t("td",{staticStyle:{"text-align":"left"}},[s._v("主节点")]),s._v(" "),t("td",[s._v("---")])]),s._v(" "),t("tr",[t("td",{staticStyle:{"text-align":"left"}},[s._v("redis-6389")]),s._v(" "),t("td",{staticStyle:{"text-align":"left"}},[s._v("6389")]),s._v(" "),t("td",{staticStyle:{"text-align":"left"}},[s._v("从节点")]),s._v(" "),t("td",[s._v("redis-6379")])]),s._v(" "),t("tr",[t("td",{staticStyle:{"text-align":"left"}},[s._v("redis-6380")]),s._v(" "),t("td",{staticStyle:{"text-align":"left"}},[s._v("6380")]),s._v(" "),t("td",{staticStyle:{"text-align":"left"}},[s._v("主节点")]),s._v(" "),t("td",[s._v("---")])]),s._v(" "),t("tr",[t("td",{staticStyle:{"text-align":"left"}},[s._v("redis-6390")]),s._v(" "),t("td",{staticStyle:{"text-align":"left"}},[s._v("6390")]),s._v(" "),t("td",{staticStyle:{"text-align":"left"}},[s._v("从节点")]),s._v(" "),t("td",[s._v("redis-6380")])]),s._v(" "),t("tr",[t("td",{staticStyle:{"text-align":"left"}},[s._v("redis-6381")]),s._v(" "),t("td",{staticStyle:{"text-align":"left"}},[s._v("6381")]),s._v(" "),t("td",{staticStyle:{"text-align":"left"}},[s._v("主节点")]),s._v(" "),t("td",[s._v("---")])]),s._v(" "),t("tr",[t("td",{staticStyle:{"text-align":"left"}},[s._v("redis-6391")]),s._v(" "),t("td",{staticStyle:{"text-align":"left"}},[s._v("6391")]),s._v(" "),t("td",{staticStyle:{"text-align":"left"}},[s._v("从节点")]),s._v(" "),t("td",[s._v("redis-6381")])])])]),s._v(" "),t("blockquote",[t("p",[t("strong",[s._v("注意")]),s._v("：建议为集群内 "),t("strong",[s._v("所有节点")]),s._v(" 统一目录，一般划分三个目录："),t("code",[s._v("conf")]),s._v("、"),t("code",[s._v("data")]),s._v("、"),t("code",[s._v("log")]),s._v("，分别存放 "),t("strong",[s._v("配置")]),s._v("、"),t("strong",[s._v("数据")]),s._v(" 和 "),t("strong",[s._v("日志")]),s._v(" 相关文件。把 "),t("code",[s._v("6")]),s._v(" 个节点配置统一放在 "),t("code",[s._v("conf")]),s._v(" 目录下。")])]),s._v(" "),t("h4",{attrs:{id:"_3-1-1-创建redis各实例目录"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-1-创建redis各实例目录"}},[s._v("#")]),s._v(" 3.1.1. 创建redis各实例目录")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("$ sudo mkdir -p /usr/local/redis-cluster\n$ cd /usr/local/redis-cluster\n$ sudo mkdir conf data log\n$ sudo mkdir -p data/redis-6379 data/redis-6389 data/redis-6380 data/redis-6390 data/redis-6381 data/redis-6391\n复制代码\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("h4",{attrs:{id:"_3-1-2-redis配置文件管理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-2-redis配置文件管理"}},[s._v("#")]),s._v(" 3.1.2. redis配置文件管理")]),s._v(" "),t("p",[s._v("根据以下 "),t("strong",[s._v("模板")]),s._v(" 配置各个实例的 "),t("code",[s._v("redis.conf")]),s._v("，以下只是搭建集群需要的 "),t("strong",[s._v("基本配置")]),s._v("，可能需要根据实际情况做修改。")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("# redis后台运行\ndaemonize yes\n# 绑定的主机端口\nbind 127.0.0.1\n# 数据存放目录\ndir /usr/local/redis-cluster/data/redis-6379\n# 进程文件\npidfile /var/run/redis-cluster/${自定义}.pid\n# 日志文件\nlogfile /usr/local/redis-cluster/log/${自定义}.log\n# 端口号\nport 6379\n# 开启集群模式，把注释#去掉\ncluster-enabled yes\n# 集群的配置，配置文件首次启动自动生成\ncluster-config-file /usr/local/redis-cluster/conf/${自定义}.conf\n# 请求超时，设置10秒\ncluster-node-timeout 10000\n# aof日志开启，有需要就开启，它会每次写操作都记录一条日志\nappendonly yes\n复制代码\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br")])]),t("ul",[t("li",[t("strong",[s._v("redis-6379.conf")])])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("daemonize yes\nbind 127.0.0.1\ndir /usr/local/redis-cluster/data/redis-6379\npidfile /var/run/redis-cluster/redis-6379.pid\nlogfile /usr/local/redis-cluster/log/redis-6379.log\nport 6379\ncluster-enabled yes\ncluster-config-file /usr/local/redis-cluster/conf/node-6379.conf\ncluster-node-timeout 10000\nappendonly yes\n复制代码\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])]),t("ul",[t("li",[t("strong",[s._v("redis-6389.conf")])])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("daemonize yes\nbind 127.0.0.1\ndir /usr/local/redis-cluster/data/redis-6389\npidfile /var/run/redis-cluster/redis-6389.pid\nlogfile /usr/local/redis-cluster/log/redis-6389.log\nport 6389\ncluster-enabled yes\ncluster-config-file /usr/local/redis-cluster/conf/node-6389.conf\ncluster-node-timeout 10000\nappendonly yes\n复制代码\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])]),t("ul",[t("li",[t("strong",[s._v("redis-6380.conf")])])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("daemonize yes\nbind 127.0.0.1\ndir /usr/local/redis-cluster/data/redis-6380\npidfile /var/run/redis-cluster/redis-6380.pid\nlogfile /usr/local/redis-cluster/log/redis-6380.log\nport 6380\ncluster-enabled yes\ncluster-config-file /usr/local/redis-cluster/conf/node-6380.conf\ncluster-node-timeout 10000\nappendonly yes\n复制代码\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])]),t("ul",[t("li",[t("strong",[s._v("redis-6390.conf")])])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("daemonize yes\nbind 127.0.0.1\ndir /usr/local/redis-cluster/data/redis-6390\npidfile /var/run/redis-cluster/redis-6390.pid\nlogfile /usr/local/redis-cluster/log/redis-6390.log\nport 6390\ncluster-enabled yes\ncluster-config-file /usr/local/redis-cluster/conf/node-6390.conf\ncluster-node-timeout 10000\nappendonly yes\n复制代码\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])]),t("ul",[t("li",[t("strong",[s._v("redis-6381.conf")])])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("daemonize yes\nbind 127.0.0.1\ndir /usr/local/redis-cluster/data/redis-6381\npidfile /var/run/redis-cluster/redis-6381.pid\nlogfile /usr/local/redis-cluster/log/redis-6381.log\nport 6381\ncluster-enabled yes\ncluster-config-file /usr/local/redis-cluster/conf/node-6381.conf\ncluster-node-timeout 10000\nappendonly yes\n复制代码\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])]),t("ul",[t("li",[t("strong",[s._v("redis-6391.conf")])])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("daemonize yes\nbind 127.0.0.1\ndir /usr/local/redis-cluster/data/redis-6391\npidfile /var/run/redis-cluster/redis-6391.pid\nlogfile /usr/local/redis-cluster/log/redis-6391.log\nport 6391\ncluster-enabled yes\ncluster-config-file /usr/local/redis-cluster/conf/node-6391.conf\ncluster-node-timeout 10000\nappendonly yes\n复制代码\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])]),t("h3",{attrs:{id:"_3-2-环境准备"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-环境准备"}},[s._v("#")]),s._v(" 3.2. 环境准备")]),s._v(" "),t("h4",{attrs:{id:"_3-2-1-安装ruby环境"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-1-安装ruby环境"}},[s._v("#")]),s._v(" 3.2.1. 安装Ruby环境")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("$ sudo brew install ruby\n复制代码\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("h4",{attrs:{id:"_3-2-2-准备rubygem-redis依赖"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-2-准备rubygem-redis依赖"}},[s._v("#")]),s._v(" 3.2.2. 准备rubygem redis依赖")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("$ sudo gem install redis\nPassword:\nFetching: redis-4.0.2.gem (100%)\nSuccessfully installed redis-4.0.2\nParsing documentation for redis-4.0.2\nInstalling ri documentation for redis-4.0.2\nDone installing documentation for redis after 1 seconds\n1 gem installed\n复制代码\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])]),t("h4",{attrs:{id:"_3-2-3-拷贝redis-trib-rb到集群根目录"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-3-拷贝redis-trib-rb到集群根目录"}},[s._v("#")]),s._v(" 3.2.3. 拷贝redis-trib.rb到集群根目录")]),s._v(" "),t("p",[t("code",[s._v("redis-trib.rb")]),s._v(" 是 "),t("code",[s._v("redis")]),s._v(" 官方推出的管理 "),t("code",[s._v("redis")]),s._v(" "),t("strong",[s._v("集群")]),s._v(" 的工具，集成在 "),t("code",[s._v("redis")]),s._v(" 的源码 "),t("code",[s._v("src")]),s._v(" 目录下，将基于 "),t("code",[s._v("redis")]),s._v(" 提供的 "),t("strong",[s._v("集群命令")]),s._v(" 封装成 "),t("strong",[s._v("简单")]),s._v("、"),t("strong",[s._v("便捷")]),s._v("、"),t("strong",[s._v("实用")]),s._v(" 的 "),t("strong",[s._v("操作工具")]),s._v("。")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("$ sudo cp /usr/local/redis-4.0.11/src/redis-trib.rb /usr/local/redis-cluster\n复制代码\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("查看 "),t("code",[s._v("redis-trib.rb")]),s._v(" 命令环境是否正确，输出如下：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("$ ./redis-trib.rb \nUsage: redis-trib <command> <options> <arguments ...>\n\n  create          host1:port1 ... hostN:portN\n                  --replicas <arg>\n  check           host:port\n  info            host:port\n  fix             host:port\n                  --timeout <arg>\n  reshard         host:port\n                  --from <arg>\n                  --to <arg>\n                  --slots <arg>\n                  --yes\n                  --timeout <arg>\n                  --pipeline <arg>\n  rebalance       host:port\n                  --weight <arg>\n                  --auto-weights\n                  --use-empty-masters\n                  --timeout <arg>\n                  --simulate\n                  --pipeline <arg>\n                  --threshold <arg>\n  add-node        new_host:new_port existing_host:existing_port\n                  --slave\n                  --master-id <arg>\n  del-node        host:port node_id\n  set-timeout     host:port milliseconds\n  call            host:port command arg arg .. arg\n  import          host:port\n                  --from <arg>\n                  --copy\n                  --replace\n  help            (show this help)\n\nFor check, fix, reshard, del-node, set-timeout you can specify the host and port of any working node in the cluster.\n复制代码\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br")])]),t("p",[t("code",[s._v("redis-trib.rb")]),s._v(" 是 "),t("code",[s._v("redis")]),s._v(" 作者用 "),t("code",[s._v("ruby")]),s._v(" 完成的。"),t("code",[s._v("redis-trib.rb")]),s._v(" "),t("strong",[s._v("命令行工具")]),s._v(" 的具体功能如下：")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",{staticStyle:{"text-align":"left"}},[s._v("命令")]),s._v(" "),t("th",{staticStyle:{"text-align":"left"}},[s._v("作用")])])]),s._v(" "),t("tbody",[t("tr",[t("td",{staticStyle:{"text-align":"left"}},[s._v("create")]),s._v(" "),t("td",{staticStyle:{"text-align":"left"}},[s._v("创建集群")])]),s._v(" "),t("tr",[t("td",{staticStyle:{"text-align":"left"}},[s._v("check")]),s._v(" "),t("td",{staticStyle:{"text-align":"left"}},[s._v("检查集群")])]),s._v(" "),t("tr",[t("td",{staticStyle:{"text-align":"left"}},[s._v("info")]),s._v(" "),t("td",{staticStyle:{"text-align":"left"}},[s._v("查看集群信息")])]),s._v(" "),t("tr",[t("td",{staticStyle:{"text-align":"left"}},[s._v("fix")]),s._v(" "),t("td",{staticStyle:{"text-align":"left"}},[s._v("修复集群")])]),s._v(" "),t("tr",[t("td",{staticStyle:{"text-align":"left"}},[s._v("reshard")]),s._v(" "),t("td",{staticStyle:{"text-align":"left"}},[s._v("在线迁移slot")])]),s._v(" "),t("tr",[t("td",{staticStyle:{"text-align":"left"}},[s._v("rebalance")]),s._v(" "),t("td",{staticStyle:{"text-align":"left"}},[s._v("平衡集群节点slot数量")])]),s._v(" "),t("tr",[t("td",{staticStyle:{"text-align":"left"}},[s._v("add-node")]),s._v(" "),t("td",{staticStyle:{"text-align":"left"}},[s._v("将新节点加入集群")])]),s._v(" "),t("tr",[t("td",{staticStyle:{"text-align":"left"}},[s._v("del-node")]),s._v(" "),t("td",{staticStyle:{"text-align":"left"}},[s._v("从集群中删除节点")])]),s._v(" "),t("tr",[t("td",{staticStyle:{"text-align":"left"}},[s._v("set-timeout")]),s._v(" "),t("td",{staticStyle:{"text-align":"left"}},[s._v("设置集群节点间心跳连接的超时时间")])]),s._v(" "),t("tr",[t("td",{staticStyle:{"text-align":"left"}},[s._v("call")]),s._v(" "),t("td",{staticStyle:{"text-align":"left"}},[s._v("在集群全部节点上执行命令")])]),s._v(" "),t("tr",[t("td",{staticStyle:{"text-align":"left"}},[s._v("import")]),s._v(" "),t("td",{staticStyle:{"text-align":"left"}},[s._v("将外部redis数据导入集群")])])])]),s._v(" "),t("h3",{attrs:{id:"_3-3-安装集群"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-安装集群"}},[s._v("#")]),s._v(" 3.3. 安装集群")]),s._v(" "),t("h4",{attrs:{id:"_3-3-1-启动redis服务节点"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-1-启动redis服务节点"}},[s._v("#")]),s._v(" 3.3.1. 启动redis服务节点")]),s._v(" "),t("p",[s._v("运行如下命令启动 "),t("code",[s._v("6")]),s._v(" 台 "),t("code",[s._v("redis")]),s._v(" 节点：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("sudo redis-server conf/redis-6379.conf\nsudo redis-server conf/redis-6389.conf\nsudo redis-server conf/redis-6380.conf\nsudo redis-server conf/redis-6390.conf\nsudo redis-server conf/redis-6381.conf\nsudo redis-server conf/redis-6391.conf\n复制代码\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("p",[s._v("启动完成后，"),t("code",[s._v("redis")]),s._v(" 以集群模式启动，查看各个 "),t("code",[s._v("redis")]),s._v(" 节点的进程状态：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("$ ps -ef | grep redis-server\n    0  1908     1   0  4:59下午 ??         0:00.01 redis-server *:6379 [cluster] \n    0  1911     1   0  4:59下午 ??         0:00.01 redis-server *:6389 [cluster] \n    0  1914     1   0  4:59下午 ??         0:00.01 redis-server *:6380 [cluster] \n    0  1917     1   0  4:59下午 ??         0:00.01 redis-server *:6390 [cluster] \n    0  1920     1   0  4:59下午 ??         0:00.01 redis-server *:6381 [cluster] \n    0  1923     1   0  4:59下午 ??         0:00.01 redis-server *:6391 [cluster] \n复制代码\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("p",[s._v("在每个 "),t("code",[s._v("redis")]),s._v(" 节点的 "),t("code",[s._v("redis.conf")]),s._v(" 文件中，我们都配置了 "),t("code",[s._v("cluster-config-file")]),s._v(" 的文件路径，集群启动时，"),t("code",[s._v("conf")]),s._v(" 目录会新生成 "),t("strong",[s._v("集群")]),s._v(" 节点配置文件。查看文件列表如下：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("$ tree -L 3 .\n.\n├── appendonly.aof\n├── conf\n│   ├── node-6379.conf\n│   ├── node-6380.conf\n│   ├── node-6381.conf\n│   ├── node-6389.conf\n│   ├── node-6390.conf\n│   ├── node-6391.conf\n│   ├── redis-6379.conf\n│   ├── redis-6380.conf\n│   ├── redis-6381.conf\n│   ├── redis-6389.conf\n│   ├── redis-6390.conf\n│   └── redis-6391.conf\n├── data\n│   ├── redis-6379\n│   ├── redis-6380\n│   ├── redis-6381\n│   ├── redis-6389\n│   ├── redis-6390\n│   └── redis-6391\n├── log\n│   ├── redis-6379.log\n│   ├── redis-6380.log\n│   ├── redis-6381.log\n│   ├── redis-6389.log\n│   ├── redis-6390.log\n│   └── redis-6391.log\n└── redis-trib.rb\n\n9 directories, 20 files\n复制代码\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br")])]),t("h4",{attrs:{id:"_3-3-2-redis-trib关联集群节点"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-2-redis-trib关联集群节点"}},[s._v("#")]),s._v(" 3.3.2. redis-trib关联集群节点")]),s._v(" "),t("p",[s._v("按照 "),t("strong",[s._v("从主到从")]),s._v(" 的方式 "),t("strong",[s._v("从左到右")]),s._v(" 依次排列 "),t("code",[s._v("6")]),s._v(" 个 "),t("code",[s._v("redis")]),s._v(" 节点。")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("$ sudo ./redis-trib.rb create --replicas 1 127.0.0.1:6379 127.0.0.1:6380 127.0.0.1:6381 127.0.0.1:6389 127.0.0.1:6390 127.0.0.1:6391\n复制代码\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("集群创建后，"),t("code",[s._v("redis-trib")]),s._v(" 会先将 "),t("code",[s._v("16384")]),s._v(" 个 "),t("strong",[s._v("哈希槽")]),s._v(" 分配到 "),t("code",[s._v("3")]),s._v(" 个 "),t("strong",[s._v("主节点")]),s._v("，即 "),t("code",[s._v("redis-6379")]),s._v("，"),t("code",[s._v("redis-6380")]),s._v(" 和 "),t("code",[s._v("redis-6381")]),s._v("。然后将各个 "),t("strong",[s._v("从节点")]),s._v(" 指向 "),t("strong",[s._v("主节点")]),s._v("，进行 "),t("strong",[s._v("数据同步")]),s._v("。")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v(">>> Creating cluster\n>>> Performing hash slots allocation on 6 nodes...\nUsing 3 masters:\n127.0.0.1:6379\n127.0.0.1:6380\n127.0.0.1:6381\nAdding replica 127.0.0.1:6390 to 127.0.0.1:6379\nAdding replica 127.0.0.1:6391 to 127.0.0.1:6380\nAdding replica 127.0.0.1:6389 to 127.0.0.1:6381\n>>> Trying to optimize slaves allocation for anti-affinity\n[WARNING] Some slaves are in the same host as their master\nM: ad4b9ffceba062492ed67ab336657426f55874b7 127.0.0.1:6379\n   slots:0-5460 (5461 slots) master\nM: df23c6cad0654ba83f0422e352a81ecee822702e 127.0.0.1:6380\n   slots:5461-10922 (5462 slots) master\nM: ab9da92d37125f24fe60f1f33688b4f8644612ee 127.0.0.1:6381\n   slots:10923-16383 (5461 slots) master\nS: 25cfa11a2b4666021da5380ff332b80dbda97208 127.0.0.1:6389\n   replicates ad4b9ffceba062492ed67ab336657426f55874b7\nS: 48e0a4b539867e01c66172415d94d748933be173 127.0.0.1:6390\n   replicates df23c6cad0654ba83f0422e352a81ecee822702e\nS: d881142a8307f89ba51835734b27cb309a0fe855 127.0.0.1:6391\n   replicates ab9da92d37125f24fe60f1f33688b4f8644612ee\n复制代码\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br")])]),t("p",[s._v("然后输入 "),t("code",[s._v("yes")]),s._v("，"),t("code",[s._v("redis-trib.rb")]),s._v(" 开始执行 "),t("strong",[s._v("节点握手")]),s._v(" 和 "),t("strong",[s._v("槽分配")]),s._v(" 操作，输出如下：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("Can I set the above configuration? (type 'yes' to accept): yes\n>>> Nodes configuration updated\n>>> Assign a different config epoch to each node\n>>> Sending CLUSTER MEET messages to join the cluster\nWaiting for the cluster to join....\n>>> Performing Cluster Check (using node 127.0.0.1:6379)\nM: ad4b9ffceba062492ed67ab336657426f55874b7 127.0.0.1:6379\n   slots:0-5460 (5461 slots) master\n   1 additional replica(s)\nM: ab9da92d37125f24fe60f1f33688b4f8644612ee 127.0.0.1:6381\n   slots:10923-16383 (5461 slots) master\n   1 additional replica(s)\nS: 48e0a4b539867e01c66172415d94d748933be173 127.0.0.1:6390\n   slots: (0 slots) slave\n   replicates df23c6cad0654ba83f0422e352a81ecee822702e\nS: d881142a8307f89ba51835734b27cb309a0fe855 127.0.0.1:6391\n   slots: (0 slots) slave\n   replicates ab9da92d37125f24fe60f1f33688b4f8644612ee\nM: df23c6cad0654ba83f0422e352a81ecee822702e 127.0.0.1:6380\n   slots:5461-10922 (5462 slots) master\n   1 additional replica(s)\nS: 25cfa11a2b4666021da5380ff332b80dbda97208 127.0.0.1:6389\n   slots: (0 slots) slave\n   replicates ad4b9ffceba062492ed67ab336657426f55874b7\n[OK] All nodes agree about slots configuration.\n>>> Check for open slots...\n>>> Check slots coverage...\n[OK] All 16384 slots covered.\n复制代码\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br")])]),t("p",[s._v("执行 "),t("strong",[s._v("集群检查")]),s._v("，检查各个 "),t("code",[s._v("redis")]),s._v(" 节点占用的 "),t("strong",[s._v("哈希槽")]),s._v("（"),t("code",[s._v("slot")]),s._v("）的个数以及 "),t("code",[s._v("slot")]),s._v(" "),t("strong",[s._v("覆盖率")]),s._v("。"),t("code",[s._v("16384")]),s._v(" 个槽位中，"),t("strong",[s._v("主节点")]),s._v(" "),t("code",[s._v("redis-6379")]),s._v("、"),t("code",[s._v("redis-6380")]),s._v(" 和 "),t("code",[s._v("redis-6381")]),s._v(" 分别占用了 "),t("code",[s._v("5461")]),s._v("、"),t("code",[s._v("5461")]),s._v(" 和 "),t("code",[s._v("5462")]),s._v(" 个槽位。")]),s._v(" "),t("h4",{attrs:{id:"_3-3-3-redis主节点的日志"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-3-redis主节点的日志"}},[s._v("#")]),s._v(" 3.3.3. redis主节点的日志")]),s._v(" "),t("p",[s._v("可以发现，通过 "),t("code",[s._v("BGSAVE")]),s._v(" 命令，"),t("strong",[s._v("从节点")]),s._v(" "),t("code",[s._v("redis-6389")]),s._v(" 在 "),t("strong",[s._v("后台")]),s._v(" 异步地从 "),t("strong",[s._v("主节点")]),s._v(" "),t("code",[s._v("redis-6379")]),s._v(" 同步数据。")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("$ cat log/redis-6379.log \n1907:C 05 Sep 16:59:52.960 # oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo\n1907:C 05 Sep 16:59:52.961 # Redis version=4.0.11, bits=64, commit=00000000, modified=0, pid=1907, just started\n1907:C 05 Sep 16:59:52.961 # Configuration loaded\n1908:M 05 Sep 16:59:52.964 * Increased maximum number of open files to 10032 (it was originally set to 256).\n1908:M 05 Sep 16:59:52.965 * No cluster configuration found, I'm ad4b9ffceba062492ed67ab336657426f55874b7\n1908:M 05 Sep 16:59:52.967 * Running mode=cluster, port=6379.\n1908:M 05 Sep 16:59:52.967 # Server initialized\n1908:M 05 Sep 16:59:52.967 * Ready to accept connections\n1908:M 05 Sep 17:01:17.782 # configEpoch set to 1 via CLUSTER SET-CONFIG-EPOCH\n1908:M 05 Sep 17:01:17.812 # IP address for this node updated to 127.0.0.1\n1908:M 05 Sep 17:01:22.740 # Cluster state changed: ok\n1908:M 05 Sep 17:01:23.681 * Slave 127.0.0.1:6389 asks for synchronization\n1908:M 05 Sep 17:01:23.681 * Partial resynchronization not accepted: Replication ID mismatch (Slave asked for '4c5afe96cac51cde56039f96383ea7217ef2af41', my replication IDs are '037b661bf48c80c577d1fa937ba55367a3692921' and '0000000000000000000000000000000000000000')\n1908:M 05 Sep 17:01:23.681 * Starting BGSAVE for SYNC with target: disk\n1908:M 05 Sep 17:01:23.682 * Background saving started by pid 1952\n1952:C 05 Sep 17:01:23.683 * DB saved on disk\n1908:M 05 Sep 17:01:23.749 * Background saving terminated with success\n1908:M 05 Sep 17:01:23.752 * Synchronization with slave 127.0.0.1:6389 succeeded\n复制代码\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br")])]),t("h4",{attrs:{id:"_3-3-4-redis集群完整性检测"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-4-redis集群完整性检测"}},[s._v("#")]),s._v(" 3.3.4. redis集群完整性检测")]),s._v(" "),t("p",[s._v("使用 "),t("code",[s._v("redis-trib.rb check")]),s._v(" 命令检测之前创建的 "),t("strong",[s._v("两个集群")]),s._v(" 是否成功，"),t("code",[s._v("check")]),s._v(" 命令只需要给出集群中 "),t("strong",[s._v("任意一个节点地址")]),s._v(" 就可以完成 "),t("strong",[s._v("整个集群")]),s._v(" 的 "),t("strong",[s._v("检查工作")]),s._v("，命令如下：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("$ ./redis-trib.rb check 127.0.0.1:6379\n复制代码\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("当最后输出如下信息，提示集群 "),t("strong",[s._v("所有的槽")]),s._v(" 都已分配到节点：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("[OK] All nodes agree about slots configuration.\n>>> Check for open slots...\n>>> Check slots coverage...\n[OK] All 16384 slots covered.\n复制代码\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("h1",{attrs:{id:"小结"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#小结"}},[s._v("#")]),s._v(" 小结")]),s._v(" "),t("p",[s._v("本文介绍了 "),t("code",[s._v("Redis")]),s._v(" "),t("strong",[s._v("集群解决方案")]),s._v("，"),t("strong",[s._v("数据分布")]),s._v(" 和 "),t("strong",[s._v("集群搭建")]),s._v("。集群方案包括 "),t("strong",[s._v("客户端分区")]),s._v(" 方案，"),t("strong",[s._v("代理分区")]),s._v(" 方案 和 "),t("strong",[s._v("查询路由")]),s._v(" 方案。"),t("strong",[s._v("数据分布")]),s._v(" 部分简单地对 "),t("strong",[s._v("节点取余")]),s._v(" 分区，"),t("strong",[s._v("一致性哈希")]),s._v(" 分区以及 "),t("strong",[s._v("虚拟槽")]),s._v(" 分区进行了阐述和对比。最后对使用 "),t("code",[s._v("Redis-trib")]),s._v(" 搭建了一个 "),t("strong",[s._v("三主三从")]),s._v(" 的 "),t("strong",[s._v("虚拟槽")]),s._v(" 集群示例。")])])}),[],!1,null,null,null);t.default=r.exports}}]);