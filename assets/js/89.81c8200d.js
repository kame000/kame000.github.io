(window.webpackJsonp=window.webpackJsonp||[]).push([[89],{492:function(s,a,t){"use strict";t.r(a);var e=t(2),n=Object(e.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"_1-cachefiles介绍"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-cachefiles介绍"}},[s._v("#")]),s._v(" 1.CacheFiles介绍")]),s._v(" "),a("blockquote",[a("p",[s._v("NFS是一种经常使用到的网络共享文件系统，在分布式环境下，多台服务器的文件共享是一个问题。然而，对于这个问题，最常想到最容易做到的那就非NFS莫属了。那么如何来提高NFS文件的访问性能呢？加上缓存呗。没错。在linux下，有一个缓存文件系统叫FS-Cache，来缓存网络文件系统，如NFS。 FS-Cache是在linux内核版本2.6.30及以上版本引入的。在RHCE6.x 、CentOS6.x版本下可用。")])]),s._v(" "),a("p",[s._v("为了使FS-Cache工作，需要缓存后端来提供实际存储。默认的缓存后端是cachefiles。因此，一旦设置了cachefiles，它会为NSF共享自动的启用文件缓存。")]),s._v(" "),a("blockquote",[a("p",[s._v("FS-Cache是由David Howells开发的。当前的设计是对Andrew文件系统和网络文件系统的操作。 需要开启cachefilesd的守护进程来管理。该守护进程管理缓存文件和目录，将网络文件系统如AFS、NFS永久缓存到本地磁盘。")])]),s._v(" "),a("h3",{attrs:{id:"_2-cachefiles前提条件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-cachefiles前提条件"}},[s._v("#")]),s._v(" 2.CacheFiles前提条件")]),s._v(" "),a("p",[s._v("需要本地文件系统支持用户自定义的扩展文件属性，如xattr。因为cachefiles使用xattr存储额外信息来维护缓存的。\next4文件系统默认启用xattr。\n如果是使用ext3文件系统，需要加上user_xattr选项。按照如下步骤操作：")]),s._v(" "),a("div",{staticClass:"language-yml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yml"}},[a("code",[s._v("    vim /etc/fstab\n    /dev/sdb1 /data ext3 defaults"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("user_xattr 0 0\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mount -o remount /data")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("warning"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" user_xattr针对缓存存储分区而言的。"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("/warning"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("h3",{attrs:{id:"_3-安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-安装"}},[s._v("#")]),s._v(" 3. 安装")]),s._v(" "),a("p",[a("code",[s._v("# yum install cachefilesd.x86_64")])]),s._v(" "),a("h3",{attrs:{id:"_4-配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-配置"}},[s._v("#")]),s._v(" 4. 配置")]),s._v(" "),a("div",{staticClass:"language-yml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim /etc/cachefilesd.conf")]),s._v("\ndir /var/cache/fscache\ntag mycache\nbrun 10%\nbcull 7%\nbstop 3%\nfrun 10%\nfcull 7%\nfstop 3%\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Assuming you're using SELinux with the default security policy included in")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# this package")]),s._v("\nsecctx system_u"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("system_r"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("cachefiles_kernel_t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("s0\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("h4",{attrs:{id:"说明"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#说明"}},[s._v("#")]),s._v(" 说明")]),s._v(" "),a("div",{staticClass:"language-yml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("dir")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 缓存root目录。默认/var/cache/fscache。\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("tag")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 指定一个FS"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v('Cache标签，用来区分多个缓存。默认是"CacheFiles"。\nsecctx system_u'),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("system_r"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("cachefiles_kernel_t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("s0 ： 开启SELinux的话，需要更改安全上下文。\nbrun 10%"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" bcull 7%"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" bstop 3%"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" frun 10%"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" fcull 7%"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" fstop 3% ： 缓存策略。\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("h3",{attrs:{id:"_5-缓存剔除规则"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-缓存剔除规则"}},[s._v("#")]),s._v(" 5. 缓存剔除规则")]),s._v(" "),a("p",[s._v("缓存需要删除来释放空间，将最少使用的对象丢弃掉。cachefiles是基于访问时间来清除缓存的。空的目录如果不使用将删掉。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("*"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" brun\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("*"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" frun\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("如果剩余空间和缓存中可用的文件数超过了上面的限制，缓存剔除关闭。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("*"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" bcull\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("*"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" fcull\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("如果可用空间或缓存中的可用文件数量低于上面的限制，缓存剔除将开启。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("*"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" bstop\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("*"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" fstop\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("如果可用空间或缓存中的可用文件数量低于上面任一限制，然后，没有进一步的分配磁盘空间或文件被允许直到再次超过上面限制。")]),s._v(" "),a("p",[s._v("必须按照下面原则设置：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<=")]),s._v(" bstop "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" bcull "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" brun "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<=")]),s._v(" fstop "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" fcull "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" frun "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("[warning]这些都是可利用的空间和可用的文件的百分比.[/warning]")]),s._v(" "),a("h3",{attrs:{id:"_6-缓存结构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-缓存结构"}},[s._v("#")]),s._v(" 6. 缓存结构")]),s._v(" "),a("p",[s._v("cachefiles模块将在缓存root目录下自动创建两个子目录：cache和graveyard。\n主动缓存对象存储于cache目录下。守护进程检测graveyard目录，并将删除任何出现在该目录中的缓存。")]),s._v(" "),a("h3",{attrs:{id:"_7-nfs挂载启用fsc选项"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_7-nfs挂载启用fsc选项"}},[s._v("#")]),s._v(" 7. NFS挂载启用fsc选项")]),s._v(" "),a("div",{staticClass:"language-yml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yml"}},[a("code",[s._v("    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# /etc/init.d/cachefilesd restart")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mount -t nfs 10.31.247.202:/data /data/nfs/ -o fsc,remount")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("查看缓存状态")]),s._v(" "),a("p",[a("code",[s._v("[warning]注意FSC列的值，如果是yes说明启用，否则没有。[/warning]")])]),s._v(" "),a("h2",{attrs:{id:"_8-测试"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_8-测试"}},[s._v("#")]),s._v(" 8. 测试")]),s._v(" "),a("p",[s._v("在没有使用"),a("code",[s._v("cachefiles")]),s._v("情况下：")]),s._v(" "),a("p",[s._v("在使用"),a("code",[s._v("cachefiles")]),s._v("情况下：")]),s._v(" "),a("p",[s._v("第一次耗时长，是由于第一次没有缓存。")]),s._v(" "),a("h2",{attrs:{id:"_9-查看cachefiles统计信息"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_9-查看cachefiles统计信息"}},[s._v("#")]),s._v(" 9. 查看cachefiles统计信息")]),s._v(" "),a("p",[a("code",[s._v("cat /proc/fs/fscache/stats")])])])}),[],!1,null,null,null);a.default=n.exports}}]);