(window.webpackJsonp=window.webpackJsonp||[]).push([[18],{424:function(s,a,e){"use strict";e.r(a);var r=e(2),n=Object(r.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"基于harbor搭建docker-registry"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#基于harbor搭建docker-registry"}},[s._v("#")]),s._v(" 基于Harbor搭建docker registry")]),s._v(" "),a("p",[a("strong",[s._v("环境")])]),s._v(" "),a("p",[s._v("本文记录一下在Centos7.3操作系统上，基于Harbor来搭建docker registry。当前环境为：")]),s._v(" "),a("p",[a("code",[s._v("# cat /etc/centos-release")]),s._v("\nCentOS Linux release 7.3.1611 (Core)")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# uname -a")]),s._v("\nLinux bogon "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3.10")]),s._v(".0-514.el7.x86_64 "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#1 SMP Tue Nov 22 16:42:41 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("div",{staticClass:"language-bash line-numbers-mode"},[a("div",{staticClass:"highlight-lines"},[a("div",{staticClass:"highlighted"},[s._v(" ")]),a("br"),a("br")]),a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker --version")]),s._v("\nDocker version "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("17.12")]),s._v(".1-ce, build 7390fc6\n")])]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker-compose --version")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker-compose")]),s._v(" version "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.20")]),s._v(".1, build 5d8c71b\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h2",{attrs:{id:"_1-harbor简介"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-harbor简介"}},[s._v("#")]),s._v(" 1. Harbor简介")]),s._v(" "),a("p",[s._v("Harbor工程是一个企业级的镜像服务器，用于存储和分发Docker镜像。Harbor扩展了开源软件"),a("code",[s._v("Docker Distribution")]),s._v("，添加了如"),a("code",[s._v("security")]),s._v("、"),a("code",[s._v("identity")]),s._v("和"),a("code",[s._v("management")]),s._v("等功能。作为一个企业级的私有镜像仓库，Harbor提供了更好的性能和安全性。Harbor支持建立多个"),a("code",[s._v("registries")]),s._v(",并提供这些仓库间镜像的复制能力。Harbor也提供了更加先进的安全特性，比如用户管理、访问控制、活动审计。")]),s._v(" "),a("p",[a("strong",[s._v("Harbor特性")]),s._v("：")]),s._v(" "),a("ul",[a("li",[a("p",[a("strong",[s._v("基于角色的访问控制")]),s._v(": "),a("code",[s._v("users")]),s._v("和"),a("code",[s._v("repositories")]),s._v("都是以projects的方式组织的。在一个project下面，每一个用户对镜像有不同的全向。")])]),s._v(" "),a("li",[a("p",[a("strong",[s._v("基于策略的镜像复制")]),s._v(": 在多个registry之间镜像可以同步，并且在出现错误的时候可以进行自动重试。在负载均衡、高可用性、多数据中心和异构云环境下都表现出色。")])]),s._v(" "),a("li",[a("p",[a("strong",[s._v("脆弱性扫描(Vulnerability Scanning)")]),s._v(": Harbor会周期性的扫描镜像，然后警告用户相应的脆弱性")])]),s._v(" "),a("li",[a("p",[a("strong",[s._v("LDAP/AD支持")]),s._v(": Harbor可以和已存在的企业版LDAP/AD系统集成，以提供用户认证和管理")])]),s._v(" "),a("li",[a("p",[a("strong",[s._v("镜像删除 & 垃圾回收")]),s._v(": Images可以被删除，然后回收它们所占用的空间")])]),s._v(" "),a("li",[a("p",[a("strong",[s._v("可信任(Notary)")]),s._v(": 可以确保镜像的真实性")])]),s._v(" "),a("li",[a("p",[a("strong",[s._v("用户界面(Graphical user portal)")]),s._v(": 用户可以人容易的浏览、搜索仓库和管理工程")])]),s._v(" "),a("li",[a("p",[a("strong",[s._v("审计(Auditing)")]),s._v(": 所有对仓库的操作都会被跟踪记录")])]),s._v(" "),a("li",[a("p",[a("strong",[s._v("RESTful API")]),s._v(": 对于大部分的管理操作都提供了RESTful API， 很容易和外部系统进行集成")])]),s._v(" "),a("li",[a("p",[a("strong",[s._v("易部署")]),s._v(": 提供了离线和在线安装")])])]),s._v(" "),a("h2",{attrs:{id:"_2-harbor的安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-harbor的安装"}},[s._v("#")]),s._v(" 2. Harbor的安装")]),s._v(" "),a("p",[s._v("这里介绍的是通过"),a("code",[s._v("Harbor安装文件")]),s._v("的方式来安装Harbor。在Linux操作系统上至少需要如下环境：")]),s._v(" "),a("h3",{attrs:{id:"_2-1-下载harbor离线安装包"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-下载harbor离线安装包"}},[s._v("#")]),s._v(" 2.1 下载Harbor离线安装包")]),s._v(" "),a("p",[s._v("到"),a("a",{attrs:{href:"https://github.com/vmware/harbor/releases",target:"_blank",rel:"noopener noreferrer"}},[s._v("Harbor Release"),a("OutboundLink")],1),s._v("页面下载对应的离线安装包，目前我们下载最新版本"),a("code",[s._v("v1.4.0")]),s._v(":")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" /opt/harbor-inst\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /opt/harbor-inst\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" https://storage.googleapis.com/harbor-releases/release-1.4.0/harbor-offline-installer-v1.4.0.tgz\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("h3",{attrs:{id:"_2-2-目标主机相关配置推荐"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-目标主机相关配置推荐"}},[s._v("#")]),s._v(" 2.2 目标主机相关配置推荐")]),s._v(" "),a("p",[s._v("Harbor部署完后会运行多个Docker containers，因此可以部署在任何支持docker的Linux发布版本上。部署的目标主机需要安装"),a("code",[s._v("Python")]),s._v(", "),a("code",[s._v("Docker")]),s._v("和"),a("code",[s._v("Docker Compose")]),s._v("。")]),s._v(" "),a("p",[a("strong",[s._v("硬件环境：")])]),s._v(" "),a("table",[a("thead",[a("tr",[a("th",[s._v("Resource")]),s._v(" "),a("th",[s._v("Capacity")]),s._v(" "),a("th",[s._v("Description")])])]),s._v(" "),a("tbody",[a("tr",[a("td",[s._v("CPU")]),s._v(" "),a("td",[s._v("minimal 2 CPU")]),s._v(" "),a("td",[s._v("4 CPU is prefered")])]),s._v(" "),a("tr",[a("td",[s._v("Mem")]),s._v(" "),a("td",[s._v("minimal 4GB")]),s._v(" "),a("td",[s._v("8GB is preffered")])]),s._v(" "),a("tr",[a("td",[s._v("Disk")]),s._v(" "),a("td",[s._v("minimal 40GB")]),s._v(" "),a("td",[s._v("160GB is preffered")])])])]),s._v(" "),a("p",[a("strong",[s._v("软件环境")])]),s._v(" "),a("table",[a("thead",[a("tr",[a("th",[s._v("Software")]),s._v(" "),a("th",[s._v("Version")]),s._v(" "),a("th",[s._v("Description")])])]),s._v(" "),a("tbody",[a("tr",[a("td",[s._v("Python")]),s._v(" "),a("td",[s._v("version 2.7 or higher")]),s._v(" "),a("td",[s._v("注意： 在有一些Linux发布版本(Gentoo、Arch)默认没有安装Python，此时你必须手动安装")])]),s._v(" "),a("tr",[a("td",[s._v("Docker Engine")]),s._v(" "),a("td",[s._v("version 1.10 or higher")]),s._v(" "),a("td",[s._v("具体安装手册，请参看相关文档:https://docs.docker.com/engine/installation/")])]),s._v(" "),a("tr",[a("td",[s._v("Docker Compose")]),s._v(" "),a("td",[s._v("version 1.6.0 or higher")]),s._v(" "),a("td",[s._v("具体安装手册，请参看相关文档:https://docs.docker.com/compose/install/")])]),s._v(" "),a("tr",[a("td",[s._v("Openssl")]),s._v(" "),a("td",[s._v("latest is preffered")]),s._v(" "),a("td",[s._v("用于为Harbor产生证书和秘钥")])])])]),s._v(" "),a("p",[a("strong",[s._v("网络端口")])]),s._v(" "),a("table",[a("thead",[a("tr",[a("th",[s._v("Port")]),s._v(" "),a("th",[s._v("Protocol")]),s._v(" "),a("th",[s._v("Description")])])]),s._v(" "),a("tbody",[a("tr",[a("td",[s._v("443")]),s._v(" "),a("td",[s._v("HTTPS")]),s._v(" "),a("td",[s._v("在https协议下，Harbor UI与API将会在本端口上接收请求")])]),s._v(" "),a("tr",[a("td",[s._v("4443")]),s._v(" "),a("td",[s._v("HTTPS")]),s._v(" "),a("td",[s._v("Harbor的Docker Content Trust service将会连接到本端口，只在Notary启用时使用")])]),s._v(" "),a("tr",[a("td",[s._v("80")]),s._v(" "),a("td",[s._v("HTTP")]),s._v(" "),a("td",[s._v("在http协议下，Harbor UI与API将会在本端口上接收请求")])])])]),s._v(" "),a("p",[s._v("我们当前的硬件环境：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("//物理CPU个数\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# cat /proc/cpuinfo| grep "physical id"| sort| uniq| wc -l')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n\n//每个CPU核数\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# cat /proc/cpuinfo| grep "cpu cores"| uniq')]),s._v("\ncpu cores       "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("\n\n//逻辑CPU个数\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /proc/cpuinfo  | grep processor")]),s._v("\nprocessor       "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nprocessor       "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\nprocessor       "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\nprocessor       "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /proc/meminfo | grep MemTotal")]),s._v("\nMemTotal:       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10058704")]),s._v(" kB\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#  fdisk -l | grep Disk")]),s._v("\nDisk /dev/sda: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("85.9")]),s._v(" GB, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("85899345920")]),s._v(" bytes, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("167772160")]),s._v(" sectors\nDisk label type: dos\nDisk identifier: 0x000c3eb0\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br")])]),a("p",[a("strong",[s._v("我们当前软件环境")]),s._v("：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# python --version")]),s._v("\nPython "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2.7")]),s._v(".5\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker --version")]),s._v("\nDocker version "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("17.12")]),s._v(".1-ce, build 7390fc6\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker-compose --version")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker-compose")]),s._v(" version "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.20")]),s._v(".1, build 5d8c71b\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# openssl version -v")]),s._v("\nOpenSSL "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.0")]),s._v(".2k-fips  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("26")]),s._v(" Jan "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2017")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("h3",{attrs:{id:"_2-3-安装步骤"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-安装步骤"}},[s._v("#")]),s._v(" 2.3 安装步骤")]),s._v(" "),a("p",[s._v("安装Harbor一般遵循如下步骤：")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("下载Harbor installer")])]),s._v(" "),a("li",[a("p",[s._v("配置harbor.cfg")])]),s._v(" "),a("li",[a("p",[s._v("运行"),a("code",[s._v("install.sh")]),s._v("脚本进行安装并启动harbor")])])]),s._v(" "),a("h4",{attrs:{id:"_2-3-1-解压harbor安装包"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-1-解压harbor安装包"}},[s._v("#")]),s._v(" 2.3.1 解压harbor安装包")]),s._v(" "),a("p",[s._v("我们在上面下载了harbor安装包，这里解压：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# pwd")]),s._v("\n/opt/harbor-inst\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ls")]),s._v("\nharbor-offline-installer-v1.4.0.tgz\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# tar -zxvf harbor-offline-installer-v1.4.0.tgz")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd harbor")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("h4",{attrs:{id:"_2-3-2-配置harbor"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-2-配置harbor"}},[s._v("#")]),s._v(" 2.3.2 配置Harbor")]),s._v(" "),a("p",[s._v("Harbor配置参数处于"),a("code",[s._v("harbor.cfg")]),s._v("文件中。在harbor.cfg配置文件中，有两大类参数： "),a("code",[s._v("必填参数")]),s._v("和"),a("code",[s._v("可选参数")])]),s._v(" "),a("ul",[a("li",[a("p",[a("code",[s._v("required parameters")]),s._v(": 这些参数在配置文件中必须填写。在更新harbor.cfg配置文件后，调用install.sh重新安装Harbor，这些参数就会起作用")])]),s._v(" "),a("li",[a("p",[a("code",[s._v("optional parameters")]),s._v(": 这些参数在更新时是可选的。例如， 用户可以先让这些参数取默认值，然后在Harbor启动后在Web UI上来进行修改。假如这些参数在harbor.cfg中也进行了配置，那么只在第一次启动harbor有效。后续再对harbor.cfg进行更新将会被忽略。")])])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("Note: 假如你选择通过Web UI的方式来更改这些参数，确保在Harbor启动之后马上进行更改。通常，你必须在注册或创建新的用户之前设置auth_mode。\n当Harbor系统中有用户之后（出admin管理用户外"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("，auth_mode是不能被修改的\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("如下所描述的参数，你至少需要更改"),a("code",[s._v("hostname")]),s._v("属性：")]),s._v(" "),a("p",[a("strong",[s._v("Required parameters")]),s._v(":")]),s._v(" "),a("ul",[a("li",[a("p",[a("code",[s._v("hostname")]),s._v(": 目标主机的hostname名称，被用于访问WebUI和registry服务。其可以被设置为IP地址，或者你目标机器的全限定域名。例如: "),a("code",[s._v("192.168.1.10")]),s._v("或者"),a("code",[s._v("reg.yourdomain.com")]),s._v("。注意不要将hostname设置为"),a("code",[s._v("localhost")]),s._v("或者"),a("code",[s._v("127.0.0.1")]),s._v(", registry服务需要能够被外网访问的到。")])]),s._v(" "),a("li",[a("p",[a("code",[s._v("ui_url_protocol")]),s._v(": 可以设置为http或者https，默认值为http。该协议被用于访问Web UI和"),a("code",[s._v("token/notification")]),s._v("服务。假如"),a("code",[s._v("Notary")]),s._v("被使能的话，则必须设置为https。默认情况下采用http协议，要想设置为https,请参看"),a("a",{attrs:{href:"https://ivanzz1001.github.io/records/post/docker/2018/04/04/Configuring%20Harbor%20with%20HTTPS%20Access",target:"_blank",rel:"noopener noreferrer"}},[s._v("Configuring Harbor with HTTPS Access"),a("OutboundLink")],1)])]),s._v(" "),a("li",[a("p",[a("code",[s._v("db_password")]),s._v(": 当auth采用db_auth方式时，用于设置MySQL数据库的密码。请在任何实际生产环境中，修改此密码")])]),s._v(" "),a("li",[a("p",[a("code",[s._v("max_job_workers")]),s._v(": 用于设置job service中"),a("code",[s._v("replication")]),s._v("worker的最大数（默认为3）。对于每一个image replication任务，一个worker会同步repository中所有tags到远程目标地址。增大本字段的值，允许在一个系统中有更多的并发复制进程。然而，每个replication worker都会消耗一定数量的network/CPU/IO资源，请基于你当前的硬件环境选择一个合适的值。")])]),s._v(" "),a("li",[a("p",[a("code",[s._v("customize_crt")]),s._v(": 可以被设置为on或者off，默认值为on。当本属性设置为on时，prepare脚本会创建一个"),a("code",[s._v("private key")]),s._v("及"),a("code",[s._v("root certificate")]),s._v(",以用于registry token的验证。假如本属性被设置为off的话，你可以自己手动来产生"),a("code",[s._v("private key")]),s._v("及"),a("code",[s._v("root certificate")]),s._v("。请参看:"),a("a",{attrs:{href:"https://github.com/vmware/harbor/blob/master/docs/customize_token_service.md",target:"_blank",rel:"noopener noreferrer"}},[s._v("Customize Key and Certificate of Harbor Token Service"),a("OutboundLink")],1)])]),s._v(" "),a("li",[a("p",[a("code",[s._v("ssl_cert")]),s._v(": SSL certificate路径，当协议被设置为https时使用")])]),s._v(" "),a("li",[a("p",[a("code",[s._v("ssl_cert_key")]),s._v(": SSL key路径，当协议被设置为https时使用")])]),s._v(" "),a("li",[a("p",[a("code",[s._v("secretkey_path")]),s._v(": 用于加密和机密远程registry密码的key路径")])]),s._v(" "),a("li",[a("p",[a("code",[s._v("log_rotate_count")]),s._v(": 用于设置日志在回滚多少次之后被删除。假如被设置为0，则日志不会被回滚，而是会被直接删除")])]),s._v(" "),a("li",[a("p",[a("code",[s._v("log_rotate_size")]),s._v(": 用于设置日志在多大时会进行回滚，单位可以是K/M/G，分别表示KB/MB/GB。")])])]),s._v(" "),a("p",[a("strong",[s._v("Optional parameters")]),s._v(":")]),s._v(" "),a("ul",[a("li",[a("p",[a("code",[s._v("Email settings")]),s._v(": 这些信息主要是为了重置Harbor密码时使用，通常情况下我们并不需要。")])]),s._v(" "),a("li",[a("p",[a("code",[s._v("harbor_admin_password")]),s._v(": 用于设置管理员初始密码。该密码只在Harbor第一次启动时有效。启动之后该密码将会被忽略，Administrator的密码应该在UI中进行设置。注意，默认的用户名/密码为"),a("code",[s._v("admin/Harbor12345")]),s._v("。")])]),s._v(" "),a("li",[a("p",[a("code",[s._v("auth_mode")]),s._v(": 用户认证的类型，默认情况下为"),a("code",[s._v("db_auth")]),s._v("，这种情况下用户名密码被存放在数据库中。如果要使用"),a("code",[s._v("LDAP")]),s._v("认证的话，请将此字段设置为"),a("code",[s._v("ldap_auth")]),s._v("。")])])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("IMPORTANT: 当要从一个已存在的Harbor实例升级的时候，你必须确保在harbor.cfg中配置的auth_mode是相同的，否则在更新后可能会造成用户不能正常登录\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("ul",[a("li",[a("p",[a("code",[s._v("ldap_url")]),s._v(": LDAP端点的URL(例如：ldaps://ldap.mydomain.com)。只在auth_mode被设置为"),a("code",[s._v("ldap_auth")]),s._v("时使用")])]),s._v(" "),a("li",[a("p",[a("code",[s._v("ldap_searchdn")]),s._v("、"),a("code",[s._v("ldap_search_pwd")]),s._v("、"),a("code",[s._v("ldap_basedn")]),s._v("、"),a("code",[s._v("ldap_filter")]),s._v("、"),a("code",[s._v("ldap_uid")]),s._v("、"),a("code",[s._v("ldap_scope")])])]),s._v(" "),a("li",[a("p",[a("code",[s._v("self_registration")]),s._v(": 可选值为on/off，默认为on。本选项用于使能或禁止注册成为本系统的账户。当被禁止时，新用户只能由admin用户来创建，在Harbor中只有admin用户可以创建新用户。注意： 当auth_mode被设置为"),a("code",[s._v("ldap_auth")]),s._v("时，self-registration功能总是会被禁止，并且此选项会被忽略。")])]),s._v(" "),a("li",[a("p",[a("code",[s._v("token_expiration")]),s._v(": token创建多长时间之后会过期，默认是30min")])]),s._v(" "),a("li",[a("p",[a("code",[s._v("project_creation_restriction")]),s._v(": 本flag用于控制哪些用户有权限来创建projects。默认情况下，任何用户都可以创建project，假如设置为"),a("code",[s._v("adminonly")]),s._v("，则只有admin用户可以创建project。")])])]),s._v(" "),a("h4",{attrs:{id:"_2-3-3-配置存储后端-可选"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-3-配置存储后端-可选"}},[s._v("#")]),s._v(" 2.3.3 配置存储后端(可选）")]),s._v(" "),a("p",[s._v("默认情况下，Harbor存储镜像到本地文件系统。在实际的生产环境下，你可以采用其他的存储后端来代替本地文件系统，例如可以采用S3、OpenStack Swift、Ceph等。而这你需要修改的文件是"),a("code",[s._v("common/templates/registry/config.yml")]),s._v("的"),a("code",[s._v("storage")]),s._v("字段。例如，假如你需要配置存储后端为Openstack swift，则storage段类似如下：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("storage:\n  swift:\n    username: admin\n    password: ADMIN_PASS\n    authurl: http://keystone_addr:35357/v3/auth\n    tenant: admin\n    domain: default\n    region: regionOne\n    container: docker_images\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("p",[s._v("想要了解详细的后端存储配置，请参看"),a("a",{attrs:{href:"https://docs.docker.com/registry/configuration/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Registry Configuration Reference"),a("OutboundLink")],1)]),s._v(" "),a("h3",{attrs:{id:"_2-4-完成安装并启动harbor"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-完成安装并启动harbor"}},[s._v("#")]),s._v(" 2.4 完成安装并启动Harbor")]),s._v(" "),a("p",[s._v("一旦harbor.cfg及存储后端(可选）完成配置，使用"),a("code",[s._v("install.sh")]),s._v("脚本完成安装并启动Harbor。")]),s._v(" "),a("p",[a("strong",[s._v("1) 默认安装(without Notary/Clair)")])]),s._v(" "),a("p",[s._v("Harbor已经集成了Notary/Clair(用于vulnerability scanning）。然而，默认的安装并不包含Notary/Clair:")]),s._v(" "),a("pre",{staticStyle:{"margin-block-start":"0px","margin-block-end":"0px",margin:"0.5em 0px",padding:"0.5em 18.6094px",border:"1px solid rgb(204, 204, 204)",outline:"0px","font-weight":"inherit","font-style":"inherit","font-family":'Monaco, Menlo, Consolas, "Courier New", monospace',"font-size":"0.9em","vertical-align":"baseline",background:"rgb(47, 43, 43)",color:"rgb(166, 226, 46)","line-height":"1.5","border-radius":"0.35em","overflow-wrap":"break-word",overflow:"auto"}},[s._v("# sudo ./install.sh\n")]),s._v(" "),a("p",[s._v("假如一切工作正常的话，你可以打开一个用户界面，然后访问后台管理页面"),a("code",[s._v("http://reg.yourdomain.com/")]),s._v("(注意这里请将reg.yourdomain.com替换为你在harbor.cfg中配置的hostname字段的值），默认的后台管理username/password为admin/Harbor12345")]),s._v(" "),a("p",[s._v("登录admin管理页面，然后创建一个新的工程，例如"),a("code",[s._v("myproject")]),s._v("，你可以使用docker命令来登录并push镜像(默认情况下，registry server监听在80端口上）:")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("# docker login reg.yourdomain.com\n# docker push reg.yourdomain.com/myproject/myrepo:mytag\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[a("code",[s._v("IMPORTANT")]),s._v(": 默认情况下安装Harbor，使用的是http协议。这样你必须为docker daemon添加"),a("code",[s._v("--insecure-registry")]),s._v("，并重启docker daemon服务")]),s._v(" "),a("p",[a("strong",[s._v("2) Installation with Notary")])]),s._v(" "),a("p",[s._v("要安装带"),a("code",[s._v("Notary")]),s._v("服务的Harbor，你可以在运行"),a("code",[s._v("install.sh")]),s._v("脚本时添加一个参数：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("# sudo ./install.sh --with-notary\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("code",[s._v("NOTE")]),s._v(": 要让Harbor支持Notary服务的话，"),a("code",[s._v("ui_url_protocol")]),s._v("必须配置为"),a("code",[s._v("https")]),s._v("。要配置https,请参考另外的章节")]),s._v(" "),a("p",[s._v("要了解更多关于"),a("code",[s._v("Notary")]),s._v("及"),a("code",[s._v("Docker Content Trust")]),s._v("相关信息，请参看docker相关文档："),a("a",{attrs:{href:"https://docs.docker.com/engine/security/trust/content_trust/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Docker Content Trust"),a("OutboundLink")],1)]),s._v(" "),a("p",[a("strong",[s._v("3) Installation with Clair")])]),s._v(" "),a("p",[s._v("要安装带"),a("code",[s._v("Clair")]),s._v("服务的Harbor，你可以在运行"),a("code",[s._v("install.sh")]),s._v("脚本时添加一个参数：")]),s._v(" "),a("p",[a("code",[s._v("# sudo ./install.sh --with-clair")])]),s._v(" "),a("p",[s._v("要想了解更多"),a("code",[s._v("Clair")]),s._v("相关信息，请参看"),a("a",{attrs:{href:"https://coreos.com/clair/docs/2.0.1/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Clair文档"),a("OutboundLink")],1)]),s._v(" "),a("p",[a("code",[s._v("注意")]),s._v("： 假如要同时支持Notary与Clair，你必须在同一个命令中同时指定这两个参数：")]),s._v(" "),a("p",[a("code",[s._v("# sudo ./install.sh --with-notary --with-clair")])]),s._v(" "),a("p",[s._v("欲了解更多Harbor的使用，请参看"),a("a",{attrs:{href:"https://github.com/vmware/harbor/blob/master/docs/user_guide.md",target:"_blank",rel:"noopener noreferrer"}},[s._v("User Guide of Harbor"),a("OutboundLink")],1)]),s._v(" "),a("h2",{attrs:{id:"_3-配置harbor以支持https访问"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-配置harbor以支持https访问"}},[s._v("#")]),s._v(" 3. 配置Harbor以支持https访问")]),s._v(" "),a("p",[s._v("Harbor本身在发布时并不提供任何证书，默认情况下，其使用http来提供相应服务。这使得Harbor可以相对容易来建立及运行，特别是在开发及测试环境中，这很重要。然而在实际的生产环境中，并不建议采用http。要使能https，请参看"),a("a",{attrs:{href:"https://github.com/vmware/harbor/blob/master/docs/configure_https.md",target:"_blank",rel:"noopener noreferrer"}},[s._v("Configuring Harbor with HTTPS Access"),a("OutboundLink")],1)]),s._v(" "),a("h2",{attrs:{id:"_4-harbor生命周期管理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-harbor生命周期管理"}},[s._v("#")]),s._v(" 4. Harbor生命周期管理")]),s._v(" "),a("p",[s._v("你可以使用docker-compose来管理Harbor的生命周期，下面列出一些常用的命令（说明必须在docker-compose.yml文件所在目录运行)：")]),s._v(" "),a("p",[a("strong",[s._v("1) 停止Harbor")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("# sudo docker-compose stop\nStopping nginx ... done\nStopping harbor-jobservice ... done\nStopping harbor-ui ... done\nStopping harbor-db ... done\nStopping registry ... done\nStopping harbor-log ... done\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[a("strong",[s._v("2) 在Harbor停止后，重启Harbor")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("# sudo docker-compose start\nStarting log ... done\nStarting ui ... done\nStarting mysql ... done\nStarting jobservice ... done\nStarting registry ... done\nStarting proxy ... done\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[a("strong",[s._v("3) 如果要改变Harbor的配置，首先要停止当前已存在的Harbor实例，然后更新harbor.cfg。然后再运行"),a("code",[s._v("prepare")]),s._v("脚本更新配置文件，最后再重新创建并启动Harbor实例")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("# sudo docker-compose down -v\n# vim harbor.cfg\n# sudo prepare\n# sudo docker-compose up -d\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[a("strong",[s._v("4) 移除Harbor容器，但保留文件系统上的image data及Harbor数据库")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("# sudo docker-compose down -v\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("strong",[s._v("5) 移除Harbor数据库及image data(用于干净环境下Harbor重装)")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("# rm -rf /data/database\n# rm -rf /data/registry\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h3",{attrs:{id:"_4-1-harbor-with-notary生命周期管理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-harbor-with-notary生命周期管理"}},[s._v("#")]),s._v(" 4.1 Harbor with Notary生命周期管理")]),s._v(" "),a("p",[s._v("当Harbor被安装支持Notary服务时，需要给docker-compose提供一个额外的模板文件"),a("code",[s._v("docker-compose.notary.yml")]),s._v("。docker-compose管理Harbor生命周期的命令：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("# sudo docker-compose -f ./docker-compose.yml -f ./docker-compose.notary.yml [ up|down|ps|stop|start ]\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("例如，假如你想要改变"),a("code",[s._v("harbor.cfg")]),s._v("配置文件，并重新部署带Notary服务的Harbor，那么你可以用如下的命令：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("# sudo docker-compose -f ./docker-compose.yml -f ./docker-compose.notary.yml down -v\n# vim harbor.cfg\n# sudo prepare --with-notary\n# sudo docker-compose -f ./docker-compose.yml -f ./docker-compose.notary.yml up -d\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("h3",{attrs:{id:"_4-2-harbor-with-clair生命周期管理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-harbor-with-clair生命周期管理"}},[s._v("#")]),s._v(" 4.2 Harbor with Clair生命周期管理")]),s._v(" "),a("p",[s._v("当Harbor被安装支持Clair服务时，需要给docker-compose提供一个额外的模板文件"),a("code",[s._v("docker-compose.clair.yml")]),s._v("。docker-compose管理Clair生命周期的命令：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("#  sudo docker-compose -f ./docker-compose.yml -f ./docker-compose.clair.yml [ up|down|ps|stop|start ]\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("例如，假如你想要改变"),a("code",[s._v("harbor.cfg")]),s._v("配置文件，并重新部署带Clair服务的Harbor，那么你可以用如下的命令：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("# sudo docker-compose -f ./docker-compose.yml -f ./docker-compose.clair.yml down -v\n# vim harbor.cfg\n# sudo prepare --with-clair\n# sudo docker-compose -f ./docker-compose.yml -f ./docker-compose.clair.yml up -d\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("h3",{attrs:{id:"_4-3-harbor-with-notary-and-clair生命周期管理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-harbor-with-notary-and-clair生命周期管理"}},[s._v("#")]),s._v(" 4.3 Harbor with Notary and Clair生命周期管理")]),s._v(" "),a("p",[s._v("假如你安装了同时支持Notary及Clair服务的Harbor，你应该在docker-compose命令中包含两个组件：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("# sudo docker-compose -f ./docker-compose.yml -f ./docker-compose.notary.yml -f ./docker-compose.clair.yml down -v\n# vim harbor.cfg\n# sudo prepare --with-notary --with-clair\n# sudo docker-compose -f ./docker-compose.yml -f ./docker-compose.notary.yml -f ./docker-compose.clair.yml up -d\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("请参看"),a("a",{attrs:{href:"https://docs.docker.com/compose/reference/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Docker Compose command-line reference"),a("OutboundLink")],1),s._v("以了解更多docker-compose的用法。")]),s._v(" "),a("h2",{attrs:{id:"_5-持久化数据及日志文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-持久化数据及日志文件"}},[s._v("#")]),s._v(" 5. 持久化数据及日志文件")]),s._v(" "),a("p",[s._v("默认情况下，registry的数据会被持久化到主机的"),a("code",[s._v("/data/")]),s._v("目录。即使在容器被移除或者重新创建的情况下，这些数据都会维持不变。")]),s._v(" "),a("p",[s._v("另外，Harbor使用"),a("code",[s._v("rsyslog")]),s._v("来收集每一个容器的日志。默认情况下，这些日志文件都被存储在"),a("code",[s._v("/var/log/harbor")]),s._v("目录下，我们可以使用这些日志来处理一些相关问题。")]),s._v(" "),a("h2",{attrs:{id:"_6-定制化harbor监听端口"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-定制化harbor监听端口"}},[s._v("#")]),s._v(" 6. 定制化Harbor监听端口")]),s._v(" "),a("p",[s._v("默认情况下，Harbor会监听80端口(http)和443端口(假如配置了https)，以此来处理Harbor的后台管理操作及支持docker的相关命令。你也可以对这些端口进行相应的定制。")]),s._v(" "),a("h3",{attrs:{id:"_6-1-定制http协议端口"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-1-定制http协议端口"}},[s._v("#")]),s._v(" 6.1 定制http协议端口")]),s._v(" "),a("p",[a("strong",[s._v("1) 修改docker-compose.yml文件")])]),s._v(" "),a("p",[s._v("替换第一个"),a("code",[s._v("80")]),s._v("端口为一个定制化指定端口，例如"),a("code",[s._v("8888:80")]),s._v(":")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('proxy:\n    image: library/nginx:1.11.5\n    restart: always\n    volumes:\n      - ./config/nginx:/etc/nginx\n    ports:\n      - 8888:80\n      - 443:443\n    depends_on:\n      - mysql\n      - registry\n      - ui\n      - log\n    logging:\n      driver: "syslog"\n      options: \n        syslog-address: "tcp://127.0.0.1:1514"\n        tag: "proxy"\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br")])]),a("p",[a("strong",[s._v("2) 修改harbor.cfg文件，添加端口到"),a("code",[s._v("hostname")]),s._v("参数")])]),s._v(" "),a("p",[a("code",[s._v("hostname = 192.168.0.2:8888")])]),s._v(" "),a("p",[a("strong",[s._v("3) 重新部署Harbor")])]),s._v(" "),a("p",[s._v("请参看前面”Harbor生命周期管理”相关章节。")]),s._v(" "),a("h3",{attrs:{id:"_6-2-定制https协议端口"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-2-定制https协议端口"}},[s._v("#")]),s._v(" 6.2 定制https协议端口")]),s._v(" "),a("p",[a("strong",[s._v("1) 在Harbor中使能HTTPS")])]),s._v(" "),a("p",[s._v("请参看相关章节。")]),s._v(" "),a("p",[a("strong",[s._v("2) 修改docker-compose.yml文件")])]),s._v(" "),a("p",[s._v("将第一个"),a("code",[s._v("443")]),s._v("端口替换为一个定制化指定端口，例如"),a("code",[s._v("8888:80")]),s._v(":")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('proxy:\n    image: library/nginx:1.11.5\n    restart: always\n    volumes:\n      - ./config/nginx:/etc/nginx\n    ports:\n      - 80:80\n      - 8888:443\n    depends_on:\n      - mysql\n      - registry\n      - ui\n      - log\n    logging:\n      driver: "syslog"\n      options: \n        syslog-address: "tcp://127.0.0.1:1514"\n        tag: "proxy"\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br")])]),a("p",[a("strong",[s._v("3) 修改harbor.cfg文件，添加端口到"),a("code",[s._v("hostname")]),s._v("参数")])]),s._v(" "),a("p",[a("code",[s._v("hostname = 192.168.0.2:8888")])]),s._v(" "),a("p",[a("strong",[s._v("4) 重新部署Harbor")])]),s._v(" "),a("p",[s._v("请参看前面”Harbor生命周期管理”相关章节。")]),s._v(" "),a("h2",{attrs:{id:"_7-性能调优"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_7-性能调优"}},[s._v("#")]),s._v(" 7. 性能调优")]),s._v(" "),a("p",[s._v("默认情况下，Harbor会限制Clair容器的的CPU使用率为15000来避免其占用所有的CPU资源。这是在"),a("code",[s._v("docker-compose.clair.yml")]),s._v("文件中进行配置的。你可以根据你的硬件配置进行相应的修改。")]),s._v(" "),a("h2",{attrs:{id:"_8-troubleshooting"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_8-troubleshooting"}},[s._v("#")]),s._v(" 8. Troubleshooting")]),s._v(" "),a("p",[s._v("1） 当Harbor不能正常工作时，通过运行如下的命令来找出是否所有的容器都处于"),a("code",[s._v("UP")]),s._v("状态")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("# sudo docker-compose ps\n        Name                     Command               State                    Ports                  \n  -----------------------------------------------------------------------------------------------------\n  harbor-db           docker-entrypoint.sh mysqld      Up      3306/tcp                                \n  harbor-jobservice   /harbor/harbor_jobservice        Up                                              \n  harbor-log          /bin/sh -c crond && rsyslo ...   Up      127.0.0.1:1514->514/tcp                   \n  harbor-ui           /harbor/harbor_ui                Up                                              \n  nginx               nginx -g daemon off;             Up      0.0.0.0:443->443/tcp, 0.0.0.0:80->80/tcp\n  registry            /entrypoint.sh serve /etc/ ...   Up      5000/tcp\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("p",[s._v("假如有一个container不是处于"),a("code",[s._v("UP")]),s._v("状态，请检查"),a("code",[s._v("/var/log/harbor")]),s._v("目录下该容器的日志。例如，假如"),a("code",[s._v("harbor-ui")]),s._v("没有运行的话，你可以查询"),a("code",[s._v("ui.log")]),s._v("日志文件。")]),s._v(" "),a("ol",[a("li",[s._v("当在一个Nginx代代理或ELB(elastic load balancing)后端建立Harbor时，请在"),a("code",[s._v("common/templates/nginx/nginx.http.conf")]),s._v("文件中查询如下行：")])]),s._v(" "),a("p",[a("code",[s._v("proxy_set_header X-Forwarded-Proto $scheme;")])]),s._v(" "),a("p",[s._v("假如代理中已经有类似于"),a("code",[s._v("location /, location /v2/ 与 location /service/")]),s._v("的设置，请将其从所在section移除，然后根据上面"),a("code",[s._v("Harbor生命周期管理")]),s._v("相关章节重新部署Harbor。")]),s._v(" "),a("h2",{attrs:{id:"_9-部署示例"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_9-部署示例"}},[s._v("#")]),s._v(" 9. 部署示例")]),s._v(" "),a("p",[s._v("前面我们已经下载并解压好了harbor，这里我们进入解压好的根目录：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("# cd /opt/harbor-inst/harbor\n# ls\ncommon  docker-compose.clair.yml  docker-compose.notary.yml  docker-compose.yml  ha  harbor.cfg  harbor.v1.4.0.tar.gz  install.sh  LICENSE  NOTICE  prepare\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("我们当前ip地址为"),a("code",[s._v("192.168.69.128")]),s._v(", 用netstat查看"),a("code",[s._v("80")]),s._v("、"),a("code",[s._v("443")]),s._v("等端口也没有被占用。")]),s._v(" "),a("p",[a("strong",[s._v("1) 修改harbor.cfg的"),a("code",[s._v("hostname")]),s._v("字段")])]),s._v(" "),a("pre",{staticStyle:{"margin-block-start":"0px","margin-block-end":"0px",margin:"0.5em 0px",padding:"0.5em 18.6094px",border:"1px solid rgb(204, 204, 204)",outline:"0px","font-weight":"inherit","font-style":"inherit","font-family":'Monaco, Menlo, Consolas, "Courier New", monospace',"font-size":"0.9em","vertical-align":"baseline",background:"rgb(47, 43, 43)",color:"rgb(166, 226, 46)","line-height":"1.5","border-radius":"0.35em","overflow-wrap":"break-word",overflow:"auto"}},[s._v("hostname = 192.168.69.128\n")]),s._v(" "),a("p",[a("strong",[s._v("2) 执行install.sh脚本")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('# ./install.sh\n\n[Step 0]: checking installation environment ...\n\nNote: docker version: 17.12.1\n\nNote: docker-compose version: 1.20.1\n\n[Step 1]: loading Harbor images ...\n651f69aef02c: Loading layer [==================================================>]  135.8MB/135.8MB\n40a1aad64343: Loading layer [==================================================>]  23.24MB/23.24MB\n3fe2713e4072: Loading layer [==================================================>]  12.16MB/12.16MB\nba3a1eb0e375: Loading layer [==================================================>]   17.3MB/17.3MB\n447427ec5e1a: Loading layer [==================================================>]  15.87kB/15.87kB\n4ccb4026663c: Loading layer [==================================================>]  3.072kB/3.072kB\n16faa95946a1: Loading layer [==================================================>]  29.46MB/29.46MB\nLoaded image: vmware/notary-server-photon:v0.5.1-v1.4.0\nfa7ba9fd42c9: Loading layer [==================================================>]  10.95MB/10.95MB\n4e400f9ae23e: Loading layer [==================================================>]   17.3MB/17.3MB\n2802fb27c88b: Loading layer [==================================================>]  15.87kB/15.87kB\ne6367a4e1e1e: Loading layer [==================================================>]  3.072kB/3.072kB\n8ece8dfcdd98: Loading layer [==================================================>]  28.24MB/28.24MB\nLoaded image: vmware/notary-signer-photon:v0.5.1-v1.4.0\na7dd1a8afcaf: Loading layer [==================================================>]  396.7MB/396.7MB\n05adebbe496f: Loading layer [==================================================>]  9.216kB/9.216kB\n86eb534949fa: Loading layer [==================================================>]  9.216kB/9.216kB\nd7f127c69380: Loading layer [==================================================>]   7.68kB/7.68kB\n5ac1c4dc5ee9: Loading layer [==================================================>]  1.536kB/1.536kB\nd0bec56b5b1a: Loading layer [==================================================>]  9.728kB/9.728kB\n4bbe83860556: Loading layer [==================================================>]   2.56kB/2.56kB\ne526f9e6769f: Loading layer [==================================================>]  3.072kB/3.072kB\nLoaded image: vmware/harbor-db:v1.4.0\n1cff102bbda2: Loading layer [==================================================>]  154.1MB/154.1MB\n04c9f3e07de1: Loading layer [==================================================>]  10.75MB/10.75MB\n7b6c7bf54f5c: Loading layer [==================================================>]  2.048kB/2.048kB\n42f8acdb7fe3: Loading layer [==================================================>]  48.13kB/48.13kB\n5b6299d0a1df: Loading layer [==================================================>]   10.8MB/10.8MB\nLoaded image: vmware/clair-photon:v2.0.1-v1.4.0\n6534131f457c: Loading layer [==================================================>]  94.76MB/94.76MB\n73f582101e4b: Loading layer [==================================================>]  6.656kB/6.656kB\n86d847823c48: Loading layer [==================================================>]  6.656kB/6.656kB\nLoaded image: vmware/postgresql-photon:v1.4.0\n5cd250d5a352: Loading layer [==================================================>]  23.24MB/23.24MB\nad3fd52b54f3: Loading layer [==================================================>]  14.99MB/14.99MB\n13b1e24cc368: Loading layer [==================================================>]  14.99MB/14.99MB\nLoaded image: vmware/harbor-adminserver:v1.4.0\nc26c69706710: Loading layer [==================================================>]  23.24MB/23.24MB\n223f6fe02cc8: Loading layer [==================================================>]  23.45MB/23.45MB\n1fc843c8698a: Loading layer [==================================================>]  7.168kB/7.168kB\ne09293610ee7: Loading layer [==================================================>]  10.39MB/10.39MB\nd59f9780b1d8: Loading layer [==================================================>]  23.44MB/23.44MB\nLoaded image: vmware/harbor-ui:v1.4.0\ndd4753242e59: Loading layer [==================================================>]  73.07MB/73.07MB\n95aed61ca251: Loading layer [==================================================>]  3.584kB/3.584kB\n1864f9818562: Loading layer [==================================================>]  3.072kB/3.072kB\nda2a19f80b81: Loading layer [==================================================>]  4.096kB/4.096kB\n058531639e75: Loading layer [==================================================>]  3.584kB/3.584kB\na84e69fb619b: Loading layer [==================================================>]  10.24kB/10.24kB\nLoaded image: vmware/harbor-log:v1.4.0\nb1056051f246: Loading layer [==================================================>]  23.24MB/23.24MB\n07678065e08b: Loading layer [==================================================>]  19.19MB/19.19MB\na2d9bdb8f5fb: Loading layer [==================================================>]  19.19MB/19.19MB\nLoaded image: vmware/harbor-jobservice:v1.4.0\n7f58ce57cd5e: Loading layer [==================================================>]  4.805MB/4.805MB\nLoaded image: vmware/nginx-photon:v1.4.0\n4c8965978b77: Loading layer [==================================================>]  23.24MB/23.24MB\n1466c942edde: Loading layer [==================================================>]  2.048kB/2.048kB\nac5c17331735: Loading layer [==================================================>]  2.048kB/2.048kB\n86824c7c466a: Loading layer [==================================================>]  2.048kB/2.048kB\nfd3bd0e70d67: Loading layer [==================================================>]   22.8MB/22.8MB\nb02195d77636: Loading layer [==================================================>]   22.8MB/22.8MB\nLoaded image: vmware/registry-photon:v2.6.2-v1.4.0\nLoaded image: vmware/photon:1.0\nLoaded image: vmware/mariadb-photon:v1.4.0\n454c81edbd3b: Loading layer [==================================================>]  135.2MB/135.2MB\ne99db1275091: Loading layer [==================================================>]  395.4MB/395.4MB\n051e4ee23882: Loading layer [==================================================>]  9.216kB/9.216kB\n6cca4437b6f6: Loading layer [==================================================>]  9.216kB/9.216kB\n1d48fc08c8bc: Loading layer [==================================================>]   7.68kB/7.68kB\n0419724fd942: Loading layer [==================================================>]  1.536kB/1.536kB\n526b2156bd7a: Loading layer [==================================================>]  637.8MB/637.8MB\n9ebf6900ecbd: Loading layer [==================================================>]  78.34kB/78.34kB\nLoaded image: vmware/harbor-db-migrator:1.4\n\n[Step 2]: preparing environment ...\nGenerated and saved secret to file: /data/secretkey\nGenerated configuration file: ./common/config/nginx/nginx.conf\nGenerated configuration file: ./common/config/adminserver/env\nGenerated configuration file: ./common/config/ui/env\nGenerated configuration file: ./common/config/registry/config.yml\nGenerated configuration file: ./common/config/db/env\nGenerated configuration file: ./common/config/jobservice/env\nGenerated configuration file: ./common/config/log/logrotate.conf\nGenerated configuration file: ./common/config/jobservice/app.conf\nGenerated configuration file: ./common/config/ui/app.conf\nGenerated certificate, key file: ./common/config/ui/private_key.pem, cert file: ./common/config/registry/root.crt\nThe configuration files are ready, please use docker-compose to start the service.\n\n[Step 3]: checking existing instance of Harbor ...\n\n[Step 4]: starting Harbor ...\nCreating network "harbor_harbor" with the default driver\nCreating harbor-log ... done\nCreating harbor-adminserver ... done\nCreating harbor-db          ... done\nCreating registry           ... done\nCreating harbor-ui          ... done\nCreating harbor-jobservice  ... done\nCreating nginx              ... done\n\n✔ ----Harbor has been installed and started successfully.----\n\nNow you should be able to visit the admin portal at http://192.168.69.128\\.\nFor more details, please visit https://github.com/vmware/harbor .\n\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br"),a("span",{staticClass:"line-number"},[s._v("62")]),a("br"),a("span",{staticClass:"line-number"},[s._v("63")]),a("br"),a("span",{staticClass:"line-number"},[s._v("64")]),a("br"),a("span",{staticClass:"line-number"},[s._v("65")]),a("br"),a("span",{staticClass:"line-number"},[s._v("66")]),a("br"),a("span",{staticClass:"line-number"},[s._v("67")]),a("br"),a("span",{staticClass:"line-number"},[s._v("68")]),a("br"),a("span",{staticClass:"line-number"},[s._v("69")]),a("br"),a("span",{staticClass:"line-number"},[s._v("70")]),a("br"),a("span",{staticClass:"line-number"},[s._v("71")]),a("br"),a("span",{staticClass:"line-number"},[s._v("72")]),a("br"),a("span",{staticClass:"line-number"},[s._v("73")]),a("br"),a("span",{staticClass:"line-number"},[s._v("74")]),a("br"),a("span",{staticClass:"line-number"},[s._v("75")]),a("br"),a("span",{staticClass:"line-number"},[s._v("76")]),a("br"),a("span",{staticClass:"line-number"},[s._v("77")]),a("br"),a("span",{staticClass:"line-number"},[s._v("78")]),a("br"),a("span",{staticClass:"line-number"},[s._v("79")]),a("br"),a("span",{staticClass:"line-number"},[s._v("80")]),a("br"),a("span",{staticClass:"line-number"},[s._v("81")]),a("br"),a("span",{staticClass:"line-number"},[s._v("82")]),a("br"),a("span",{staticClass:"line-number"},[s._v("83")]),a("br"),a("span",{staticClass:"line-number"},[s._v("84")]),a("br"),a("span",{staticClass:"line-number"},[s._v("85")]),a("br"),a("span",{staticClass:"line-number"},[s._v("86")]),a("br"),a("span",{staticClass:"line-number"},[s._v("87")]),a("br"),a("span",{staticClass:"line-number"},[s._v("88")]),a("br"),a("span",{staticClass:"line-number"},[s._v("89")]),a("br"),a("span",{staticClass:"line-number"},[s._v("90")]),a("br"),a("span",{staticClass:"line-number"},[s._v("91")]),a("br"),a("span",{staticClass:"line-number"},[s._v("92")]),a("br"),a("span",{staticClass:"line-number"},[s._v("93")]),a("br"),a("span",{staticClass:"line-number"},[s._v("94")]),a("br"),a("span",{staticClass:"line-number"},[s._v("95")]),a("br"),a("span",{staticClass:"line-number"},[s._v("96")]),a("br"),a("span",{staticClass:"line-number"},[s._v("97")]),a("br"),a("span",{staticClass:"line-number"},[s._v("98")]),a("br"),a("span",{staticClass:"line-number"},[s._v("99")]),a("br"),a("span",{staticClass:"line-number"},[s._v("100")]),a("br"),a("span",{staticClass:"line-number"},[s._v("101")]),a("br"),a("span",{staticClass:"line-number"},[s._v("102")]),a("br"),a("span",{staticClass:"line-number"},[s._v("103")]),a("br"),a("span",{staticClass:"line-number"},[s._v("104")]),a("br"),a("span",{staticClass:"line-number"},[s._v("105")]),a("br"),a("span",{staticClass:"line-number"},[s._v("106")]),a("br"),a("span",{staticClass:"line-number"},[s._v("107")]),a("br"),a("span",{staticClass:"line-number"},[s._v("108")]),a("br"),a("span",{staticClass:"line-number"},[s._v("109")]),a("br"),a("span",{staticClass:"line-number"},[s._v("110")]),a("br"),a("span",{staticClass:"line-number"},[s._v("111")]),a("br"),a("span",{staticClass:"line-number"},[s._v("112")]),a("br"),a("span",{staticClass:"line-number"},[s._v("113")]),a("br"),a("span",{staticClass:"line-number"},[s._v("114")]),a("br"),a("span",{staticClass:"line-number"},[s._v("115")]),a("br")])]),a("p",[a("strong",[s._v("3) 查询Harbor运行状态")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('# docker ps\nCONTAINER ID        IMAGE                                  COMMAND                  CREATED             STATUS                            PORTS                                                              NAMES\n10b95448f80f        vmware/nginx-photon:v1.4.0             "nginx -g \'daemon of…"   5 seconds ago       Up 4 seconds                      0.0.0.0:80->80/tcp, 0.0.0.0:443->443/tcp, 0.0.0.0:4443->4443/tcp   nginx\n64893e6ba9d3        vmware/harbor-jobservice:v1.4.0        "/harbor/start.sh"       5 seconds ago       Up 4 seconds (health: starting)                                                                      harbor-jobservice\n62220b07e57f        vmware/harbor-ui:v1.4.0                "/harbor/start.sh"       5 seconds ago       Up 5 seconds (health: starting)                                                                      harbor-ui\nce166d26724e        vmware/harbor-db:v1.4.0                "/usr/local/bin/dock…"   7 seconds ago       Up 6 seconds (health: starting)   3306/tcp                                                           harbor-db\na62d8f460c35        vmware/registry-photon:v2.6.2-v1.4.0   "/entrypoint.sh serv…"   7 seconds ago       Up 5 seconds (health: starting)   5000/tcp                                                           registry\n5e5e4bcee123        vmware/harbor-adminserver:v1.4.0       "/harbor/start.sh"       7 seconds ago       Up 6 seconds (health: starting)                                                                      harbor-adminserver\ncb6dbc564382        vmware/harbor-log:v1.4.0               "/bin/sh -c /usr/loc…"   7 seconds ago       Up 6 seconds (health: starting)   127.0.0.1:1514->10514/tcp                                          harbor-log\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("p",[a("strong",[s._v("4) 访问")])]),s._v(" "),a("p",[s._v("首先我们用curl命令访问一下：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("# curl -X GET http://192.168.69.128 -k -IL\nHTTP/1.1 200 OK\nServer: nginx\nDate: Mon, 09 Apr 2018 02:43:20 GMT\nContent-Type: text/html; charset=utf-8\nContent-Length: 810\nConnection: keep-alive\nSet-Cookie: beegosessionID=1720767232a3cdcb58a54cd13eead058; Path=/; HttpOnly\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[s._v("然后我们再用浏览器访问。")]),s._v(" "),a("p",[a("strong",[s._v("5） 向Harbor push/pull镜像")])]),s._v(" "),a("ul",[a("li",[s._v("停止Harbor")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("# docker-compose stop\nStopping nginx              ... done\nStopping harbor-jobservice  ... done\nStopping harbor-ui          ... done\nStopping harbor-db          ... done\nStopping registry           ...\nStopping registry           ... done\nStopping harbor-adminserver ... done\nStopping harbor-log         ... done\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("ul",[a("li",[s._v("修改dockerd启动脚本")])]),s._v(" "),a("p",[s._v("这里修改"),a("code",[s._v("/lib/systemd/system/docker.service")]),s._v("文件，将"),a("code",[s._v("ExecStart")]),s._v("修改为：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("ExecStart=/usr/bin/dockerd \\\n        --insecure-registry=192.168.69.128 \\\n        -H tcp://0.0.0.0:2375 \\\n        -H unix://var/run/docker.sock \\\n        -H tcp://0.0.0.0:7654\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("上面添加了"),a("code",[s._v("--insecure-registry")]),s._v("选项。然后执行再执行如下命令重启dockerd:")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("# systemctl daemon-reload\n\n# systemctl restart docker\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[a("strong",[s._v("6） 重启Harbor")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('# docker-compose start\nStarting log         ... done\nStarting registry    ... done\nStarting mysql       ... done\nStarting adminserver ... done\nStarting ui          ... done\nStarting jobservice  ... done\nStarting proxy       ... done\n# docker ps\nCONTAINER ID        IMAGE                                  COMMAND                  CREATED             STATUS                            PORTS                                                              NAMES\n10b95448f80f        vmware/nginx-photon:v1.4.0             "nginx -g \'daemon of…"   21 minutes ago      Up Less than a second             0.0.0.0:80->80/tcp, 0.0.0.0:443->443/tcp, 0.0.0.0:4443->4443/tcp   nginx\n64893e6ba9d3        vmware/harbor-jobservice:v1.4.0        "/harbor/start.sh"       21 minutes ago      Up 4 seconds (health: starting)                                                                      harbor-jobservice\n62220b07e57f        vmware/harbor-ui:v1.4.0                "/harbor/start.sh"       21 minutes ago      Up 4 seconds (health: starting)                                                                      harbor-ui\nce166d26724e        vmware/harbor-db:v1.4.0                "/usr/local/bin/dock…"   21 minutes ago      Up 57 seconds (healthy)           3306/tcp                                                           harbor-db\na62d8f460c35        vmware/registry-photon:v2.6.2-v1.4.0   "/entrypoint.sh serv…"   21 minutes ago      Up 57 seconds (healthy)           5000/tcp                                                           registry\n5e5e4bcee123        vmware/harbor-adminserver:v1.4.0       "/harbor/start.sh"       21 minutes ago      Up 4 seconds (health: starting)                                                                      harbor-adminserver\ncb6dbc564382        vmware/harbor-log:v1.4.0               "/bin/sh -c /usr/loc…"   21 minutes ago      Up 57 seconds (healthy)           127.0.0.1:1514->10514/tcp                                          harbor-log\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br")])]),a("p",[a("strong",[s._v("7) 往Harbor中push/pull镜像")])]),s._v(" "),a("ul",[a("li",[s._v("登录")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("# docker login 192.168.69.128\nUsername: admin\nPassword:\nLogin Succeeded\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("ul",[a("li",[s._v("重新为镜像打tag")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("# docker images\nREPOSITORY                    TAG                 IMAGE ID            CREATED             SIZE\ntest-image                    latest              fe9c46d12863        7 days ago          195MB\nfriendlyhello                 latest              f2ae8dec6267        9 days ago          150MB\nredis                         alpine              c27f56585938        3 weeks ago         27.7MB\n\n//这里我们用Harbor中的默认库\n# docker tag redis:alpine 192.168.69.128/library/redis:alpine\n# docker images | grep redis\n192.168.69.128/library/redis          alpine              c27f56585938        3 weeks ago         27.7MB\nredis                         alpine              c27f56585938        3 weeks ago         27.7MB\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("ul",[a("li",[s._v("上传镜像到Harbor")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("# docker push 192.168.69.128/library/redis:alpine\nThe push refers to repository [192.168.69.128/library/redis]\nf6b9463783dc: Pushed\n222a85888a99: Pushed\n1925395eabdd: Pushed\nc3d278563734: Pushed\nad9247fe8c63: Pushed\ncd7100a72410: Pushed\nalpine: digest: sha256:9d017f829df3d0800f2a2582c710143767f6dda4df584b708260e73b1a1b6db3 size: 1568\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("p",[s._v("然后我们登录网站，可以看到镜像上传成功。（注： 这里Harbor默认采用"),a("code",[s._v("Www-Authenticate: Bearer")]),s._v("认证）")]),s._v(" "),a("ul",[a("li",[s._v("下载镜像")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("//这里我们先把原来本地的镜像删除\n# docker rmi 192.168.69.128/library/redis:alpine\n\n//从Harbor镜像库拉取镜像\n# docker pull 192.168.69.128/library/redis:alpine\nalpine: Pulling from library/redis\nDigest: sha256:9d017f829df3d0800f2a2582c710143767f6dda4df584b708260e73b1a1b6db3\nStatus: Downloaded newer image for 192.168.69.128/library/redis:alpine\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[a("strong",[s._v("[参考]")])]),s._v(" "),a("ol",[a("li",[a("p",[a("a",{attrs:{href:"https://github.com/vmware/harbor",target:"_blank",rel:"noopener noreferrer"}},[s._v("harbor官网"),a("OutboundLink")],1)])]),s._v(" "),a("li",[a("p",[a("a",{attrs:{href:"https://blog.csdn.net/felix_yujing/article/details/54694294",target:"_blank",rel:"noopener noreferrer"}},[s._v("Centos7上Docker仓库Harbor的搭建"),a("OutboundLink")],1)])])])])}),[],!1,null,null,null);a.default=n.exports}}]);