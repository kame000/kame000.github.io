(window.webpackJsonp=window.webpackJsonp||[]).push([[182],{585:function(s,a,n){"use strict";n.r(a);var t=n(2),e=Object(t.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"jenkins-pipeline"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#jenkins-pipeline"}},[s._v("#")]),s._v(" Jenkins pipeline")]),s._v(" "),a("h3",{attrs:{id:"背景"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#背景"}},[s._v("#")]),s._v(" 背景")]),s._v(" "),a("p",[s._v("前段时间一直在想，怎么做CI方面的东西，后来通过整理nginx、rabbitmq、bind等等一下软件的配置，虽然都有相关的备份。但是并没有统一管理，无法做相关治理的目的。")]),s._v(" "),a("p",[s._v("有这么"),a("strong",[s._v("两种做法进行管理")]),s._v("：")]),s._v(" "),a("ul",[a("li",[s._v("通过ansible 进行管理及相关备份\n"),a("ul",[a("li",[s._v("优点: 编辑简单、方便更改等等")]),s._v(" "),a("li",[s._v("比较难做到很好版本管理")])])]),s._v(" "),a("li",[s._v("通过jenkins pipeline + gitlab  方式进行 配置文件治理。\n"),a("ul",[a("li",[s._v("版本管理方便、回退方便、完全可以自动化发布")]),s._v(" "),a("li",[s._v("需要 知晓整个构建原理、以及根据实际业务需要编写 相关脚本、需要知识相对负载。")])])])]),s._v(" "),a("p",[s._v("我选择"),a("strong",[s._v("第二种方案")]),s._v("进行治理，也就是本文主要讲解内容。背景介绍完成，进入正题。")]),s._v(" "),a("h4",{attrs:{id:"架构思路"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#架构思路"}},[s._v("#")]),s._v(" 架构思路")]),s._v(" "),a("p",[a("img",{attrs:{src:"http://img.liuwenqi.com/blog/2019-07-23-125238.jpg",alt:""}})]),s._v(" "),a("p",[s._v("git push 到gitlab >> 触发jenkins webhooks API >> 执行ansible")]),s._v(" "),a("h4",{attrs:{id:"jenkins-所需插件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#jenkins-所需插件"}},[s._v("#")]),s._v(" jenkins 所需插件")]),s._v(" "),a("p",[s._v("在插件里面搜索pipeline ，凡是有pipeline的都安装，完成后，重启jenkins")]),s._v(" "),a("h4",{attrs:{id:"gitlab-与-jenkins-绑定"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#gitlab-与-jenkins-绑定"}},[s._v("#")]),s._v(" gitlab 与 jenkins 绑定")]),s._v(" "),a("ul",[a("li",[s._v("jenkins")])]),s._v(" "),a("p",[a("img",{attrs:{src:"http://img.liuwenqi.com/blog/2019-07-03-022623.jpg",alt:""}})]),s._v(" "),a("p",[a("img",{attrs:{src:"http://img.liuwenqi.com/blog/2019-07-03-022717.jpg",alt:""}})]),s._v(" "),a("ul",[a("li",[s._v("Gitlab")])]),s._v(" "),a("p",[a("img",{attrs:{src:"http://img.liuwenqi.com/blog/2019-07-03-022744.jpg",alt:""}})]),s._v(" "),a("p",[s._v("​URL 添写上面  jenkins api ,如："),a("strong",[s._v("http://IP:8080/job/pip_base_conf/build?token=123654")])]),s._v(" "),a("p",[a("img",{attrs:{src:"http://img.liuwenqi.com/blog/2019-07-03-022840.jpg",alt:""}})]),s._v(" "),a("p",[a("img",{attrs:{src:"http://img.liuwenqi.com/blog/2019-07-03-022903.jpg",alt:""}})]),s._v(" "),a("h4",{attrs:{id:"jenkins-pipeline-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#jenkins-pipeline-2"}},[s._v("#")]),s._v(" jenkins  pipeline")]),s._v(" "),a("p",[a("img",{attrs:{src:"http://img.liuwenqi.com/blog/2019-07-03-023019.jpg",alt:""}})]),s._v(" "),a("div",{staticClass:"language-yml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yml"}},[a("code",[s._v("pipeline "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    agent any\n    environment "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v('\n        def GIT_NAME = "base_conf"\n        def CODE_DIR = "/cron"\n        def GIT_ADDR = "git@10.18.12.172'),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v('OPS"\n        def ANSIBLE_HOST_DIR = "/cron/base_conf/ansible_conf/ansible/base"\n        def ANSIBLE_HOST_NAME = "nginx'),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v('all"\n    '),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    stages "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        stage('Git') "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            steps "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                sh '/root/scripts/jenkins_pip_git_pull.sh $CODE_DIR $GIT_NAME $GIT_ADDR'\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        stage('Ansible Git pull') "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            steps "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                sh 'ansible "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("i $ANSIBLE_HOST_DIR $ANSIBLE_HOST_NAME  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("m shell "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v('a "cd $CODE_DIR/$GIT_NAME;git pull"\'\n            '),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br")])]),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"title"}),a("p",[s._v("在你的ansible服务器上创建 jenkins_pip_git_pull.sh脚本，内容如下：")])]),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token shebang important"}},[s._v("#!/bin/bash")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## Version:1.0")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("GIT_DIR")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$1")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("GIT_NAME")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$2")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("GIT_ADDR")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$3")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#echo $GIT_DIR $GIT_NAME $GIT_ADDR")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${GIT_DIR}")]),s._v("/"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${GIT_NAME}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${GIT_DIR}")]),s._v("/"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${GIT_NAME}")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" pull\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${GIT_DIR}")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" clone "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${GIT_ADDR}")]),s._v("/"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${GIT_NAME}")]),s._v(".git\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br")])])])}),[],!1,null,null,null);a.default=e.exports}}]);